<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 20 Quasi-experimental | A Guide on Data Analysis</title>
<meta name="author" content="Mike Nguyen">
<meta name="description" content="In most cases, it means that you have pre- and post-intervention data.  20.1 Regression Discontinuity  A regression discontinuity occurs when there is a discrete change (jump) in treatment...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 20 Quasi-experimental | A Guide on Data Analysis">
<meta property="og:type" content="book">
<meta property="og:image" content="/images/cover.jpg">
<meta property="og:description" content="In most cases, it means that you have pre- and post-intervention data.  20.1 Regression Discontinuity  A regression discontinuity occurs when there is a discrete change (jump) in treatment...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 20 Quasi-experimental | A Guide on Data Analysis">
<meta name="twitter:description" content="In most cases, it means that you have pre- and post-intervention data.  20.1 Regression Discontinuity  A regression discontinuity occurs when there is a discrete change (jump) in treatment...">
<meta name="twitter:image" content="/images/cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-8.1.2/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-8.1.2/highcharts.js"></script><script src="libs/highcharts-8.1.2/highcharts-3d.js"></script><script src="libs/highcharts-8.1.2/highcharts-more.js"></script><script src="libs/highcharts-8.1.2/modules/stock.js"></script><script src="libs/highcharts-8.1.2/modules/map.js"></script><script src="libs/highcharts-8.1.2/modules/annotations.js"></script><script src="libs/highcharts-8.1.2/modules/data.js"></script><script src="libs/highcharts-8.1.2/modules/drilldown.js"></script><script src="libs/highcharts-8.1.2/modules/item-series.js"></script><script src="libs/highcharts-8.1.2/modules/offline-exporting.js"></script><script src="libs/highcharts-8.1.2/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-8.1.2/modules/exporting.js"></script><script src="libs/highcharts-8.1.2/modules/export-data.js"></script><script src="libs/highcharts-8.1.2/modules/funnel.js"></script><script src="libs/highcharts-8.1.2/modules/heatmap.js"></script><script src="libs/highcharts-8.1.2/modules/treemap.js"></script><script src="libs/highcharts-8.1.2/modules/sankey.js"></script><script src="libs/highcharts-8.1.2/modules/dependency-wheel.js"></script><script src="libs/highcharts-8.1.2/modules/organization.js"></script><script src="libs/highcharts-8.1.2/modules/solid-gauge.js"></script><script src="libs/highcharts-8.1.2/modules/streamgraph.js"></script><script src="libs/highcharts-8.1.2/modules/sunburst.js"></script><script src="libs/highcharts-8.1.2/modules/vector.js"></script><script src="libs/highcharts-8.1.2/modules/wordcloud.js"></script><script src="libs/highcharts-8.1.2/modules/xrange.js"></script><script src="libs/highcharts-8.1.2/modules/tilemap.js"></script><script src="libs/highcharts-8.1.2/modules/venn.js"></script><script src="libs/highcharts-8.1.2/modules/gantt.js"></script><script src="libs/highcharts-8.1.2/modules/timeline.js"></script><script src="libs/highcharts-8.1.2/modules/parallel-coordinates.js"></script><script src="libs/highcharts-8.1.2/modules/bullet.js"></script><script src="libs/highcharts-8.1.2/modules/coloraxis.js"></script><script src="libs/highcharts-8.1.2/modules/dumbbell.js"></script><script src="libs/highcharts-8.1.2/modules/lollipop.js"></script><script src="libs/highcharts-8.1.2/modules/series-label.js"></script><script src="libs/highcharts-8.1.2/plugins/motion.js"></script><script src="libs/highcharts-8.1.2/custom/reset.js"></script><script src="libs/highcharts-8.1.2/modules/boost.js"></script><script src="libs/highchart-binding-0.8.2/highchart.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){window.dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DMNX2X65HQ');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">A Guide on Data Analysis</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="prerequisites.html"><span class="header-section-number">2</span> Prerequisites</a></li>
<li class="book-part">BASIC</li>
<li><a class="" href="descriptive-stat.html"><span class="header-section-number">3</span> Descriptive Statistics</a></li>
<li><a class="" href="basic-statistical-inference.html"><span class="header-section-number">4</span> Basic Statistical Inference</a></li>
<li class="book-part">REGRESSION</li>
<li><a class="" href="linear-regression.html"><span class="header-section-number">5</span> Linear Regression</a></li>
<li><a class="" href="non-linear-regression.html"><span class="header-section-number">6</span> Non-linear Regression</a></li>
<li><a class="" href="generalized-linear-models.html"><span class="header-section-number">7</span> Generalized Linear Models</a></li>
<li><a class="" href="linear-mixed-models.html"><span class="header-section-number">8</span> Linear Mixed Models</a></li>
<li><a class="" href="nonlinear-and-generalized-linear-mixed-models.html"><span class="header-section-number">9</span> Nonlinear and Generalized Linear Mixed Models</a></li>
<li class="book-part">RAMIFICATIONS</li>
<li><a class="" href="model-specification.html"><span class="header-section-number">10</span> Model Specification</a></li>
<li><a class="" href="imputation-missing-data.html"><span class="header-section-number">11</span> Imputation (Missing Data)</a></li>
<li><a class="" href="data.html"><span class="header-section-number">12</span> Data</a></li>
<li><a class="" href="hypothesis-testing.html"><span class="header-section-number">13</span> Hypothesis Testing</a></li>
<li><a class="" href="prediction-and-estimation.html"><span class="header-section-number">14</span> Prediction and Estimation</a></li>
<li class="book-part">EXPERIMENTAL DESIGN</li>
<li><a class="" href="sampling.html"><span class="header-section-number">15</span> Sampling</a></li>
<li><a class="" href="analysis-of-variance-anova.html"><span class="header-section-number">16</span> Analysis of Variance (ANOVA)</a></li>
<li><a class="" href="multivariate-methods.html"><span class="header-section-number">17</span> Multivariate Methods</a></li>
<li class="book-part">CAUSAL INFERENCE</li>
<li><a class="" href="causal-inference.html"><span class="header-section-number">18</span> Causal Inference</a></li>
<li><a class="" href="experimental-design.html"><span class="header-section-number">19</span> Experimental Design</a></li>
<li><a class="active" href="quasi-experimental.html"><span class="header-section-number">20</span> Quasi-experimental</a></li>
<li><a class="" href="endogeneity.html"><span class="header-section-number">21</span> Endogeneity</a></li>
<li><a class="" href="mediation.html"><span class="header-section-number">22</span> Mediation</a></li>
<li class="book-part">MISCELLANEOUS</li>
<li><a class="" href="report.html"><span class="header-section-number">23</span> Report</a></li>
<li class="book-part">APPENDIX</li>
<li><a class="" href="appendix.html"><span class="header-section-number">A</span> Appendix</a></li>
<li><a class="" href="bookdown-cheat-sheet.html"><span class="header-section-number">B</span> Bookdown cheat sheet</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/mikenguyen13/data_analysis">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="quasi-experimental" class="section level1" number="20">
<h1>
<span class="header-section-number">20</span> Quasi-experimental<a class="anchor" aria-label="anchor" href="#quasi-experimental"><i class="fas fa-link"></i></a>
</h1>
<p>In most cases, it means that you have pre- and post-intervention data.</p>
<div id="regression-discontinuity" class="section level2" number="20.1">
<h2>
<span class="header-section-number">20.1</span> Regression Discontinuity<a class="anchor" aria-label="anchor" href="#regression-discontinuity"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>
<p>A regression discontinuity occurs when there is a discrete change (jump) in treatment likelihood in the distribution of a continuous (or roughly continuous) variable (i.e., running/forcing/assignment variable).</p>
<ul>
<li>Running variable can also be time, but the argument for time to be continuous is hard to argue because usually we do not see increment of time (e.g., quarterly or annual data). Unless we have minute or hour data, then we might be able to argue for it.</li>
</ul>
</li>
<li>
<p>RD is a localized experiment at the cutoff point</p>
<ul>
<li>Hence, we always have to qualify (perfunctory) our statement in research articles that “our research might not generalize to beyond the bandwidth.”</li>
</ul>
</li>
<li><p>In reality, RD and experimental (from random assignment) estimates are very similar (<span class="citation">(<a href="references.html#ref-chaplin2018" role="doc-biblioref">Chaplin et al. 2018</a>; <a href="references.html#ref-bertanha2014" role="doc-biblioref">Bertanha and Imbens 2014</a>)</span>; <a href="https://www.mathematica.org/publications/replicating-experimental-impact-estimates-using-a-regression-discontinuity-approach">Mathematica</a> ). But still, it’s hard to prove empirically for every context (there might be future study that finds a huge difference between local estimate - causal - and overall estimate - random assignment.</p></li>
<li><p>Threats: only valid near threshold: inference at threshold is valid on average. Interestingly, random experiment showed the validity already.</p></li>
<li><p>Tradeoff between efficiency and bias</p></li>
<li><p>Regression discontinuity is under the framework of <a href="endogeneity.html#instrumental-variable">Instrumental Variable</a></p></li>
<li><p>The hard part is to find a setting that can apply, but once you find one, it’s easy to apply</p></li>
<li><p>We can also have multiple cutoff lines. However, for each cutoff line, there can only be one breakup point</p></li>
<li><p>RD can have multiple coinciding effects (i.e., joint distribution or bundled treatment), then RD effect in this case would be the joint effect.</p></li>
<li><p>As the running variable becomes more discrete your framework should be <a href="quasi-experimental.html#interrupted-time-series">Interrupted Time Series</a>, but more granular levels you can use RD. When you have infinite data (or substantially large) the two frameworks are identical. RD is always better than [Interrupted Times Series]</p></li>
</ul>
<p>There are two types of Regression Discontinuity:</p>
<ol style="list-style-type: decimal">
<li>Sharp RD: Change in treatment probability at the cutoff point is 1</li>
<li>Fuzzy RD: Change in treatment probability less than 1</li>
</ol>
<p>Consider</p>
<p><span class="math display">\[
D_i = 1_{X_i &gt; c}
\]</span></p>
<p><span class="math display">\[
D_i = 
\begin{cases}
D_i = 1 \text{ if } X_i &gt; C \\
D_i = 0 \text{ if } X_i &lt; C
\end{cases}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(D_i\)</span> = treatment effect</p></li>
<li><p><span class="math inline">\(X_i\)</span> = score variable (continuous)</p></li>
<li><p><span class="math inline">\(c\)</span> = cutoff point</p></li>
</ul>
<p><strong>Identifying assumption</strong> of RD:</p>
<p><span class="math display">\[
\begin{aligned}
\alpha_{SRDD} &amp;= E[Y_{1i} - Y_{0i} | X_i = c] \\
&amp;= E[Y_{1i}|X_i = c] - E[Y_{0i}|X_i = c]\\
&amp;= \lim_{x \to c^+} E[Y_{1i}|X_i = c] - \lim_{x \to c^=} E[Y_{0i}|X_i = c]
\end{aligned}
\]</span></p>
<p>RDD estimates the local average treatment effect (LATE), at the cutoff point which is not at the individual or population levels.</p>
<p>Since researchers typically care more about the internal validity, than external validity, localness affects only external validity.</p>
<p>Assumptions:</p>
<ul>
<li><p>Independent assignment</p></li>
<li>
<p>Continuity of conditional regression functions</p>
<ul>
<li>
<span class="math inline">\(E[Y(0)|X=x]\)</span> and <span class="math inline">\(E[Y(1)|X=x]\)</span> are continuous in x.</li>
</ul>
</li>
<li><p>RD is valid if cutpoint is <strong>exogenous (i.e., no endogenous selection)</strong> and running variable is <strong>not manipulable</strong></p></li>
</ul>
<p><br></p>
<p><strong>General Model</strong></p>
<p><span class="math display">\[
Y_i = \beta_0 + f(x_i) \beta_1 + [I(x_i \ge c)]\beta_2 + \epsilon_i
\]</span></p>
<p>where <span class="math inline">\(f(x_i)\)</span> is any functional form of <span class="math inline">\(x_i\)</span></p>
<p><strong>Simple case</strong></p>
<p>When <span class="math inline">\(f(x_i) = x_i\)</span> (linear function)</p>
<p><span class="math display">\[
Y_i = \beta_0 + x_i \beta_1 + [I(x_i \ge c)]\beta_2 + \epsilon_i
\]</span></p>
<div class="inline-figure"><img src="images/rd1.PNG" style="display: block; margin: 1em auto"></div>
<p>RD gives you <span class="math inline">\(\beta_2\)</span> (causal effect) of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> at the cutoff point</p>
<p>In practice, everyone does</p>
<p><span class="math display">\[
Y_i = \alpha_0 + f(x) \alpha _1 + [I(x_i \ge c)]\alpha_2 + [f(x_i)\times [I(x_i \ge c)]\alpha_3 + u_i
\]</span></p>
<div class="inline-figure"><img src="images/rd2.PNG" style="display: block; margin: 1em auto"></div>
<p>where we estimate different slope on different sides of the line</p>
<p>and if you estimate <span class="math inline">\(\alpha_3\)</span> to be no different from 0 then we return to the simple case</p>
<p>Notes:</p>
<ul>
<li><p>Sparse data can make <span class="math inline">\(\alpha_3\)</span> large differential effect</p></li>
<li><p>People are very skeptical when you have complex <span class="math inline">\(f(x_i)\)</span>, usual simple function forms (e.g., linear, squared term, etc.) should be good</p></li>
</ul>
<p>Bandwidth of <span class="math inline">\(c\)</span> (window)</p>
<ul>
<li><p>Closer to <span class="math inline">\(c\)</span> can give you lower bias, but also efficiency</p></li>
<li><p>Wider <span class="math inline">\(c\)</span> can increase bias, but higher efficiency.</p></li>
<li><p>Optimal bandwidth is very controversial, but usually we have to do it in the appendix for research article anyway.</p></li>
<li>
<p>We can either</p>
<ul>
<li><p>drop observations outside of bandwidth or</p></li>
<li><p>weight depends on how far and close to <span class="math inline">\(c\)</span></p></li>
</ul>
</li>
</ul>
<div id="bunching-test" class="section level3" number="20.1.1">
<h3>
<span class="header-section-number">20.1.1</span> Bunching Test<a class="anchor" aria-label="anchor" href="#bunching-test"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>Bunching happens when people self-select to a specific value in the range of a variable (e.g., key policy thresholds).</p></li>
<li><p>Review paper <span class="citation">(<a href="references.html#ref-kleven2016" role="doc-biblioref">Kleven 2016</a>)</span></p></li>
<li><p>Histogram in bunching is similar to a density curve (we want narrower bins, wider bins bias elasticity estimates)</p></li>
<li><p>We can also use bunching method to study individuals’ or firm’s responsiveness to changes in policy.</p></li>
<li>
<p>Under RD, we assume that we don’t have any manipulation in the running variable. However, bunching behavior is a manipulation by firms or individuals. Thus, violating this assumption.</p>
<ul>
<li><p>Bunching can fix this problem by estimating what densities of individuals would have been without manipulation (i.e., manipulation-free counterfactual).</p></li>
<li><p><strong>The fraction of persons who manipulated</strong> is then calculated by comparing the observed distribution to manipulation-free counterfactual distributions.</p></li>
<li><p>Under RD, we do not need this step because the observed and manipulation-free counterfactual distributions are assumed to be the same. RD assume there is no manipulation (i.e., assume the manipulation-free counterfactual distribution)</p></li>
</ul>
</li>
<li>
<p>Assumptions:</p>
<ul>
<li><p>Manipulation is <strong>one-sided</strong>: People move one way (i.e., either below the threshold to above the threshold or vice versa, but not to or away the threshold), which is similar to the monotonicity assumption under instrumental variable <a href="endogeneity.html#instrumental-variable">21.3.1</a></p></li>
<li><p>Manipulation is <strong>bounded</strong> (also known as regularity assumption): so that we can use people far away from this threshold to derive at our counterfactual distribution <span class="citation">(<a href="references.html#ref-blomquist2017" role="doc-biblioref">Blomquist et al. 2017</a>)</span></p></li>
</ul>
</li>
</ul>
<p>Steps:</p>
<ol style="list-style-type: decimal">
<li>Identify the window in which the running variable contains bunching behavior. We can do this step empirically based on data <span class="citation">(<a href="references.html#ref-bosch2020" role="doc-biblioref">Bosch, Dekker, and Strohmaier 2020</a>)</span>. Additionally robustness test is needed (i.e., varying the manipulation window).</li>
<li>Estimate the manipulation-free counterfactual</li>
<li>Calculating the standard errors for inference can follow <span class="citation">(<a href="references.html#ref-chetty2011" role="doc-biblioref">R. Chetty et al. 2011</a>)</span> where we bootstrap resampling residuals in the estimation of the counts of individuals within bins (large data can render this step unnecessary).</li>
</ol>
<p>If we pass the bunching test, we can move on to the <a href="quasi-experimental.html#placebo-test">Placebo Test</a></p>
</div>
<div id="placebo-test" class="section level3" number="20.1.2">
<h3>
<span class="header-section-number">20.1.2</span> Placebo Test<a class="anchor" aria-label="anchor" href="#placebo-test"><i class="fas fa-link"></i></a>
</h3>
<p>Before and after the cutoff point, we can run the placebo test to see whether X’s are different).</p>
<p>The placebo test is where you expect your coefficients to be not different from 0.</p>
<p>Balance on observable characteristics on both sides</p>
<p><span class="math display">\[
Z_i = \alpha_0 + \alpha_1 f(x_i) + [I(x_i \ge c)] \alpha_2 + [f(x_i) \times I(x_i \ge c)]\alpha_3 + u_i
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(x_i\)</span> is the running variable</p></li>
<li><p><span class="math inline">\(Z_i\)</span> is other characteristics of people (e.g., age, etc)</p></li>
</ul>
<p>Theoretically, <span class="math inline">\(Z_i\)</span> should no be affected by treatment. Hence, <span class="math inline">\(E(\alpha_2) = 0\)</span></p>
<p>Moreover, when you have multiple <span class="math inline">\(Z_i\)</span>, you typically have to simulate joint distribution (to avoid having significant coefficient based on chance).</p>
<p>The only way that you don’t need to generate joint distribution is when all <span class="math inline">\(Z_i\)</span>’s are independent (unlikely in reality).</p>
<p>Under RD, you shouldn’t have to do any <a href="quasi-experimental.html#matching-methods">Matching Methods</a>. Because just like when you have random assignment, there is no need to make balanced dataset before and after the cutoff. If you have to do balancing, then your RD assumptions are probably wrong in the first place.</p>
</div>
<div id="examples" class="section level3" number="20.1.3">
<h3>
<span class="header-section-number">20.1.3</span> Examples<a class="anchor" aria-label="anchor" href="#examples"><i class="fas fa-link"></i></a>
</h3>
<div id="example-1-1" class="section level4" number="20.1.3.1">
<h4>
<span class="header-section-number">20.1.3.1</span> Example 1<a class="anchor" aria-label="anchor" href="#example-1-1"><i class="fas fa-link"></i></a>
</h4>
<p>Example by <a href="https://towardsdatascience.com/the-crown-jewel-of-causal-inference-regression-discontinuity-design-rdd-bad37a68e786">Leihua Ye</a></p>
<p><span class="math display">\[
Y_i = \beta_0 + \beta_1 X_i + \beta_2 W_i + u_i
\]</span></p>
<p><span class="math display">\[
X_i = 
\begin{cases}
1, W_i \ge c \\
0, W_i &lt; c
\end{cases}
\]</span></p>
<div class="sourceCode" id="cb994"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#cutoff point = 3.5</span>
<span class="va">GPA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span>
<span class="va">future_success</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">GPA</span> <span class="op">+</span> <span class="fl">10</span> <span class="op">*</span> <span class="op">(</span><span class="va">GPA</span> <span class="op">&gt;=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>
<span class="co">#install and load the package ‘rddtools’</span>
<span class="co">#install.packages(“rddtools”)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://qua.st/rddtools/">rddtools</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: package 'rddtools' was built under R version 4.0.5</code></pre>
<pre><code>## Warning: package 'car' was built under R version 4.0.5</code></pre>
<pre><code>## Warning: package 'zoo' was built under R version 4.0.5</code></pre>
<pre><code>## Warning: package 'survival' was built under R version 4.0.5</code></pre>
<pre><code>## Warning: package 'np' was built under R version 4.0.5</code></pre>
<div class="sourceCode" id="cb1000"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rddtools/man/rdd_data.html">rdd_data</a></span><span class="op">(</span><span class="va">future_success</span>, <span class="va">GPA</span>, cutpoint <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span>
<span class="co"># plot the dataset</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>
    <span class="va">data</span>,
    col <span class="op">=</span>  <span class="st">"red"</span>,
    cex <span class="op">=</span> <span class="fl">0.1</span>,
    xlab <span class="op">=</span>  <span class="st">"GPA"</span>,
    ylab <span class="op">=</span>  <span class="st">"future_success"</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-1-1.png" width="672"></div>
<div class="sourceCode" id="cb1001"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># estimate the sharp RDD model</span>
<span class="va">rdd_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rddtools/man/rdd_reg_lm.html">rdd_reg_lm</a></span><span class="op">(</span>rdd_object <span class="op">=</span> <span class="va">data</span>, slope <span class="op">=</span>  <span class="st">"same"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="va">rdd_mod</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ ., data = dat_step1, weights = weights)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.8510 -0.6757  0.0094  0.6880  3.2894 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 16.95480    0.06708  252.76   &lt;2e-16 ***
## D           10.00710    0.11916   83.98   &lt;2e-16 ***
## x            1.97835    0.03348   59.09   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 1.023 on 997 degrees of freedom
## Multiple R-squared:  0.9587, Adjusted R-squared:  0.9586 
## F-statistic: 1.157e+04 on 2 and 997 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb1003"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the RDD model along with binned observations</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>
    <span class="va">rdd_mod</span>,
    cex <span class="op">=</span> <span class="fl">0.1</span>,
    col <span class="op">=</span>  <span class="st">"red"</span>,
    xlab <span class="op">=</span>  <span class="st">"GPA"</span>,
    ylab <span class="op">=</span>  <span class="st">"future_success"</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-3-1.png" width="672"></div>
</div>
<div id="example-2" class="section level4" number="20.1.3.2">
<h4>
<span class="header-section-number">20.1.3.2</span> Example 2<a class="anchor" aria-label="anchor" href="#example-2"><i class="fas fa-link"></i></a>
</h4>
<p><span class="citation"><a href="references.html#ref-bowblis2019" role="doc-biblioref">Bowblis and Smith</a> (<a href="references.html#ref-bowblis2019" role="doc-biblioref">2019</a>)</span></p>
<p>Occupational licensing can either increase or decrease market efficiency:</p>
<ul>
<li><p>More information means more efficiency</p></li>
<li><p>Increased entry barriers (i.e., friction) increase efficiency</p></li>
</ul>
<p>Components of RD</p>
<ul>
<li>Running variable</li>
<li>Cutoff: 120 beds or above</li>
<li>Treatment: you have to have the treatment before the cutoff point.</li>
</ul>
<p>Under OLS</p>
<p><span class="math display">\[
Y_i = \alpha_0 + X_i \alpha_1 + LW_i \alpha_2 + \epsilon_i
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(LW_i\)</span> Licensed/certified workers (in fraction format for each center).</p></li>
<li><p><span class="math inline">\(Y_i\)</span> = Quality of service</p></li>
</ul>
<p>Bias in <span class="math inline">\(\alpha_2\)</span></p>
<ul>
<li><p>Mitigation-based: terrible quality can lead to more hiring, which negatively bias <span class="math inline">\(\alpha_2\)</span></p></li>
<li><p>Preference-based: places that have higher quality staff want to keep high quality staffs.</p></li>
</ul>
<p>Under RD</p>
<p><span class="math display">\[
Y_{ist} = \beta_0 + [I(Bed \ge121)_{ist}]\beta_1 + f(Size_{ist}) \beta_2 + [f(Size_{ist}) \times I(Bed \ge 121)_{ist}] \beta_3 \\
+ X_{it} \delta + \gamma_s + \theta_t + \epsilon_{ist}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(s\)</span> = state</p></li>
<li><p><span class="math inline">\(t\)</span> = year</p></li>
<li><p><span class="math inline">\(i\)</span> = hospital</p></li>
</ul>
<p>This RD is fuzzy</p>
<p>If right near the threshold (bandwidth), we have states with different sorting (i.e., non-random), then we need the fixed-effect for state <span class="math inline">\(s\)</span>. But then your RD assumption wrong anyway, then you won’t do it in the first place</p>
<p>Technically, we could also run the fixed-effect regression, but because it’s lower in the causal inference hierarchy. Hence, we don’t do it.</p>
<p>Moreover, in the RD framework, we don’t include <span class="math inline">\(t\)</span> before treatment (but in the FE we have to include before and after)</p>
<p>If we include <span class="math inline">\(\pi_i\)</span> for each hospital, then we don’t have variation in the causal estimates (because hardly any hospital changes their bed size in the panel)</p>
<p>When you have <span class="math inline">\(\beta_1\)</span> as the intent to treat (because the treatment effect does not coincide with the intent to treat)</p>
<p>You cannot take those fuzzy cases out, because it will introduce the selection bias.</p>
<p>Note that we cannot drop cases based on behavioral choice (because we will exclude non-compliers), but we can drop when we have particular behaviors ((e.g., people like round numbers).</p>
<p>Thus, we have to use Instrument variable <a href="endogeneity.html#instrumental-variable">21.3.1</a></p>
<p>Stage 1:</p>
<p><span class="math display">\[
QSW_{ist} = \alpha_0 + [I(Bed \ge121)_{ist}]\alpha_1 + f(Size_{ist}) \alpha_2 + [f(Size_{ist}) \times I(Bed \ge 121)_{ist}] \alpha_3 \\
+ X_{it} \delta + \gamma_s + \theta_t + \epsilon_{ist}
\]</span></p>
<p>(Note: you should have different fixed effects and error term - <span class="math inline">\(\delta, \gamma_s, \theta_t, \epsilon_{ist}\)</span> from the first equation, but I ran out of Greek letters)</p>
<p>Stage 2:</p>
<p><span class="math display">\[
Y_{ist} = \gamma_0 + \gamma_1 \hat{QWS}_{ist} + f(Size_{ist}) \delta_2 + [f(Size_{ist}) \times I(Bed \ge 121)] \delta_3 \\
 + X_{it} \lambda + \eta_s + \tau_t + u_{ist}
\]</span></p>
<p>The bigger the jump (discontinuity), the more similar the 2 coefficients (<span class="math inline">\(\gamma_1 \approx \beta_1\)</span>) where <span class="math inline">\(\gamma_1\)</span> is the average treatment effect (of exposing to the policy)</p>
<p><span class="math inline">\(\beta_1\)</span> will always be closer to 0 than <span class="math inline">\(\gamma_1\)</span></p>
<p>Figure 1 shows bunching at every 5 units cutoff, but 120 is still out there.</p>
<p>If we have manipulable bunching, there should be decrease at 130</p>
<p>Since we have limited number of mass points (at the round numbers), we should clustered standard errors by the mass point</p>
<p><br></p>
</div>
</div>
</div>
<div id="difference-in-differences" class="section level2" number="20.2">
<h2>
<span class="header-section-number">20.2</span> Difference-In-Differences<a class="anchor" aria-label="anchor" href="#difference-in-differences"><i class="fas fa-link"></i></a>
</h2>
<div id="simple-dif-n-dif" class="section level3" number="20.2.1">
<h3>
<span class="header-section-number">20.2.1</span> Simple Dif-n-dif<a class="anchor" aria-label="anchor" href="#simple-dif-n-dif"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>A tool developed intuitively to study “natural experiment,” but its uses are much broader.</p></li>
<li><p><a href="data.html#fixed-effects-estimator">Fixed Effects Estimator</a> is the foundation for DID</p></li>
</ul>
<p>Consider</p>
<ul>
<li><p><span class="math inline">\(D_i = 1\)</span> treatment group</p></li>
<li><p><span class="math inline">\(D_i = 0\)</span> control group</p></li>
<li><p><span class="math inline">\(T= 1\)</span> After the treatment</p></li>
<li><p><span class="math inline">\(T =0\)</span> Before the treatment</p></li>
</ul>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th></th>
<th>After (T = 1)</th>
<th>Before (T = 0)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Treated <span class="math inline">\(D_i =1\)</span>
</td>
<td><span class="math inline">\(E[Y_{1i}(1)|D_i = 1]\)</span></td>
<td><span class="math inline">\(E[Y_{0i}(0)|D)i=1]\)</span></td>
</tr>
<tr class="even">
<td>Control <span class="math inline">\(D_i = 0\)</span>
</td>
<td><span class="math inline">\(E[Y_{0i}(1) |D_i =0]\)</span></td>
<td><span class="math inline">\(E[Y_{0i}(0)|D_i=0]\)</span></td>
</tr>
</tbody>
</table></div>
<p>missing <span class="math inline">\(E[Y_{0i}(1)|D=1]\)</span></p>
<p>The Average Treatment Effect on Treated</p>
<p><span class="math display">\[
E[Y_1(1) - Y_0(1)|D=1] \\
= \{E[Y(1)|D=1] - E[Y(1)|D=0] \} - \{E[Y(0)|D=1] - E[Y(0)|D=0] \}
\]</span></p>
<p><strong>Assumption</strong>:</p>
<ul>
<li>Parallel Trends: Difference between the treatment and control groups remain constant if there were no treatment.</li>
</ul>
<p>should be used in cases where</p>
<ul>
<li><p>you observe before and after an event</p></li>
<li><p>you have treatment and control groups</p></li>
</ul>
<p>not in cases where</p>
<ul>
<li><p>treatment is not random</p></li>
<li><p>confounders.</p></li>
</ul>
<p>Example from <a href="https://www.princeton.edu/~otorres/DID101R.pdf">Princeton</a></p>
<div class="sourceCode" id="cb1004"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://svn.r-project.org/R-packages/trunk/foreign/">foreign</a></span><span class="op">)</span>
<span class="va">mydata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/foreign/man/read.dta.html">read.dta</a></span><span class="op">(</span><span class="st">"http://dss.princeton.edu/training/Panel101.dta"</span><span class="op">)</span></code></pre></div>
<p>create a dummy variable to indicate the time when the treatment started</p>
<div class="sourceCode" id="cb1005"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mydata</span><span class="op">$</span><span class="va">time</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">mydata</span><span class="op">$</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">1994</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p>create a dummy variable to identify the treatment group</p>
<div class="sourceCode" id="cb1006"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mydata</span><span class="op">$</span><span class="va">treated</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">mydata</span><span class="op">$</span><span class="va">country</span> <span class="op">==</span> <span class="st">"E"</span> <span class="op">|</span>
                            <span class="va">mydata</span><span class="op">$</span><span class="va">country</span> <span class="op">==</span> <span class="st">"F"</span> <span class="op">|</span> <span class="va">mydata</span><span class="op">$</span><span class="va">country</span> <span class="op">==</span> <span class="st">"G"</span> ,
                        <span class="fl">1</span>,
                        <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p>create an interaction between time and treated</p>
<div class="sourceCode" id="cb1007"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mydata</span><span class="op">$</span><span class="va">did</span> <span class="op">=</span> <span class="va">mydata</span><span class="op">$</span><span class="va">time</span> <span class="op">*</span> <span class="va">mydata</span><span class="op">$</span><span class="va">treated</span></code></pre></div>
<p>estimate the DID estimator</p>
<div class="sourceCode" id="cb1008"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">didreg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">treated</span> <span class="op">+</span> <span class="va">time</span> <span class="op">+</span> <span class="va">did</span>, data <span class="op">=</span> <span class="va">mydata</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="va">didreg</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ treated + time + did, data = mydata)
## 
## Residuals:
##        Min         1Q     Median         3Q        Max 
## -9.768e+09 -1.623e+09  1.167e+08  1.393e+09  6.807e+09 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)  
## (Intercept)  3.581e+08  7.382e+08   0.485   0.6292  
## treated      1.776e+09  1.128e+09   1.575   0.1200  
## time         2.289e+09  9.530e+08   2.402   0.0191 *
## did         -2.520e+09  1.456e+09  -1.731   0.0882 .
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 2.953e+09 on 66 degrees of freedom
## Multiple R-squared:  0.08273,    Adjusted R-squared:  0.04104 
## F-statistic: 1.984 on 3 and 66 DF,  p-value: 0.1249</code></pre>
<p>The <code>did</code> coefficient is the differences-in-differences estimator. Treat has a negative effect</p>
<p><br></p>
<div id="example-by-card1993" class="section level4" number="20.2.1.1">
<h4>
<span class="header-section-number">20.2.1.1</span> Example by <span class="citation"><a href="references.html#ref-card1993" role="doc-biblioref">Card and Krueger</a> (<a href="references.html#ref-card1993" role="doc-biblioref">1993</a>)</span><a class="anchor" aria-label="anchor" href="#example-by-card1993"><i class="fas fa-link"></i></a>
</h4>
<p>found that increase in minimum wage increases employment</p>
<p>Experimental Setting:</p>
<ul>
<li><p>New Jersey (treatment) increased minimum wage</p></li>
<li><p>Penn (control) did not increase minimum wage</p></li>
</ul>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th></th>
<th></th>
<th>After</th>
<th>Before</th>
<th></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Treatment</td>
<td>NJ</td>
<td>A</td>
<td>B</td>
<td>A - B</td>
</tr>
<tr class="even">
<td>Control</td>
<td>PA</td>
<td>C</td>
<td>D</td>
<td>C - D</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>A - C</td>
<td>B - D</td>
<td>(A - B) - (C - D)</td>
</tr>
</tbody>
</table></div>
<p>where</p>
<ul>
<li><p>A - B = treatment effect + effect of time (additive)</p></li>
<li><p>C - D = effect of time</p></li>
<li><p>(A - B) - (C - D) = dif-n-dif</p></li>
</ul>
<p><strong>The identifying assumptions</strong>:</p>
<ul>
<li><p>Can’t have <strong>switchers</strong></p></li>
<li>
<p>PA is the control group</p>
<ul>
<li><p>is a good counter factual</p></li>
<li><p>is what NJ would look like if they hadn’t had the treatment</p></li>
</ul>
</li>
</ul>
<p><span class="math display">\[
Y_{jt} = \beta_0 + NJ_j \beta_1 + POST_t \beta_2 + (NJ_j \times POST_t)\beta_3+ X_{jt}\beta_4 + \epsilon_{jt}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(j\)</span> = restaurant</p></li>
<li><p><span class="math inline">\(NJ\)</span> = dummy where 1 = NJ, and 0 = PA</p></li>
<li><p><span class="math inline">\(POST\)</span> = dummy where 1 = post, and 0 = pre</p></li>
</ul>
<p>We don’t need <span class="math inline">\(\beta_4\)</span> in our model to have unbiased <span class="math inline">\(\beta_3\)</span>, but including it would give our coefficients efficiency</p>
<p>If we use <span class="math inline">\(\Delta Y_{jt}\)</span> as the dependent variable, we don’t need <span class="math inline">\(POST_t \beta_2\)</span> anymore</p>
<p>Alternative model specification is that the authors use NJ high wage restaurant as control group (still choose those that are close to the border)</p>
<p>The reason why they can’t control for everything (PA + NJ high wage) is because it’s hard to interpret the causal treatment</p>
<p>Dif-n-dif utilizes similarity in pretrend of the dependent variables. However, this is neither a necessary nor sufficient for the identifying assumption.</p>
<ul>
<li><p>It’s not sufficient because they can have multiple treatments (technically, you could include more control, but your treatment can’t interact)</p></li>
<li><p>It’s not necessary because trends can e parallel after treatment</p></li>
</ul>
<p>However, we can’t never be certain; we just try to find evidence consistent with our theory so that dif-n-dif can work.</p>
<p>Notice that we don’t need before treatment the <strong>levels of the dependent variable</strong> to be the same (e.g., same wage average in both NJ and PA), dif-n-dif only needs <strong>pre-trend (i.e., slope)</strong> to be the same for the two groups.</p>
<p><br></p>
</div>
<div id="example-by-butcher2014" class="section level4" number="20.2.1.2">
<h4>
<span class="header-section-number">20.2.1.2</span> Example by <span class="citation"><a href="references.html#ref-butcher2014" role="doc-biblioref">Butcher, McEwan, and Weerapana</a> (<a href="references.html#ref-butcher2014" role="doc-biblioref">2014</a>)</span><a class="anchor" aria-label="anchor" href="#example-by-butcher2014"><i class="fas fa-link"></i></a>
</h4>
<p>Theory:</p>
<ul>
<li>
<p>Highest achieving students are usually in hard science. Why?</p>
<ul>
<li><p>Hard to give students students the benefit of doubt for hard science</p></li>
<li><p>How unpleasant and how easy to get a job. Degrees with lower market value typically want to make you feel more pleasant</p></li>
</ul>
</li>
</ul>
<p>Under OLS</p>
<p><span class="math display">\[
E_{ij} = \beta_0 + X_i \beta_1 + G_j \beta_2 + \epsilon_{ij}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(X_i\)</span> = student attributes</p></li>
<li><p><span class="math inline">\(\beta_2\)</span> = causal estimate (from grade change)</p></li>
<li><p><span class="math inline">\(E_{ij}\)</span> = Did you choose to enroll in major <span class="math inline">\(j\)</span></p></li>
<li><p><span class="math inline">\(G_j\)</span> = grade given in major <span class="math inline">\(j\)</span></p></li>
</ul>
<p>Examine <span class="math inline">\(\hat{\beta}_2\)</span></p>
<ul>
<li><p>Negative bias: Endogenous response because department with lower enrollment rate will give better grade</p></li>
<li><p>Positive bias: hard science is already having best students (i.e., ability), so if they don’t their grades can be even lower</p></li>
</ul>
<p>Under dif-n-dif</p>
<p><span class="math display">\[
Y_{idt} = \beta_0 + POST_t \beta_1 + Treat_d \beta_2 + (POST_t \times Treat_d)\beta_3 + X_{idt} + \epsilon_{idt}
\]</span></p>
<p>where</p>
<ul>
<li>
<span class="math inline">\(Y_{idt}\)</span> = grade average</li>
</ul>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th></th>
<th>Intercept</th>
<th>Treat</th>
<th>Post</th>
<th>Treat*Post</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Treat Pre</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>Treat Post</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td>Control Pre</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>Control Post</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td></td>
<td>Average for pre-control <span class="math inline">\(\beta_0\)</span>
</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table></div>
<p>A more general specification of the dif-n-dif is that</p>
<p><span class="math display">\[
Y_{idt} = \alpha_0 + (POST_t \times Treat_d) \alpha_1 + \theta_d + \delta_t + X_{idt} + u_{idt}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\((\theta_d + \delta_t)\)</span> richer , more df than <span class="math inline">\(Treat_d \beta_2 + Post_t \beta_1\)</span> (because fixed effects subsume Post and treat)</p></li>
<li><p><span class="math inline">\(\alpha_1\)</span> should be equivalent to <span class="math inline">\(\beta_3\)</span> (if your model assumptions are correct)</p></li>
</ul>
<p>Under causal inference, <span class="math inline">\(R^2\)</span> is not so important.</p>
<p><br></p>
</div>
</div>
<div id="staggered-dif-n-dif" class="section level3" number="20.2.2">
<h3>
<span class="header-section-number">20.2.2</span> Staggered Dif-n-dif<a class="anchor" aria-label="anchor" href="#staggered-dif-n-dif"><i class="fas fa-link"></i></a>
</h3>
<div id="example-by-doleac2020" class="section level4" number="20.2.2.1">
<h4>
<span class="header-section-number">20.2.2.1</span> Example by <span class="citation"><a href="references.html#ref-doleac2020" role="doc-biblioref">Doleac and Hansen</a> (<a href="references.html#ref-doleac2020" role="doc-biblioref">2020</a>)</span><a class="anchor" aria-label="anchor" href="#example-by-doleac2020"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li><p>The purpose of banning a checking box for ex-criminal was banned because we thought that it gives more access to felons</p></li>
<li><p>Even if we ban the box, employers wouldn’t just change their behaviors. But then the unintended consequence is that employers statistically discriminate based on race</p></li>
</ul>
<p>3 types of ban the box</p>
<ol style="list-style-type: decimal">
<li>Public employer only</li>
<li>Private employer with government contract</li>
<li>All employers</li>
</ol>
<p>Main identification strategy</p>
<ul>
<li>If any county in the Metropolitan Statistical Area (MSA) adopts ban the box, it means the whole MSA is treated. Or if the state adopts “ban the ban,” every county is treated</li>
</ul>
<p>Under <a href="quasi-experimental.html#simple-dif-n-dif">Simple Dif-n-dif</a></p>
<p><span class="math display">\[
Y_{it} = \beta_0 + \beta_1 Post_t + \beta_2 treat_i + \beta_2 (Post_t \times Treat_i) + \epsilon_{it}
\]</span></p>
<p>But if there is no common post time, then we should use <a href="quasi-experimental.html#staggered-dif-n-dif">Staggered Dif-n-dif</a></p>
<p><span class="math display">\[
E_{imrt} = \alpha + \beta_1 BTB_{imt} W_{imt} + \beta_2 BTB_{mt} + \beta_3 BTB_{mt} H_{imt}+ \delta_m + D_{imt} \beta_5 + \lambda_{rt} + \delta_m\times f(t) \beta_7 + e_{imrt}
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(i\)</span> = person; <span class="math inline">\(m\)</span> = MSA; <span class="math inline">\(r\)</span> = region (US regions e.g., midwest) ; <span class="math inline">\(r\)</span> = region; <span class="math inline">\(t\)</span> = year</p></li>
<li><p><span class="math inline">\(W\)</span> = White; <span class="math inline">\(B\)</span> = Black; <span class="math inline">\(H\)</span> = Hispanic</p></li>
<li><p><span class="math inline">\(\beta_1 BTB_{imt} W_{imt} + \beta_2 BTB_{mt} + \beta_3 BTB_{mt} H_{imt}\)</span> are the 3 dif-n-dif variables (<span class="math inline">\(BTB\)</span> = “ban the box”)</p></li>
<li><p><span class="math inline">\(\delta_m\)</span> = dummy for MSI</p></li>
<li><p><span class="math inline">\(D_{imt}\)</span> = control for people</p></li>
<li><p><span class="math inline">\(\lambda_{rt}\)</span> = region by time fixed effect</p></li>
<li><p><span class="math inline">\(\delta_m \times f(t)\)</span> = linear time trend within MSA (but we should not need this if we have good pre-trend)</p></li>
</ul>
<p>If we put <span class="math inline">\(\lambda_r - \lambda_t\)</span> (separately) we will more broad fixed effect, while <span class="math inline">\(\lambda_{rt}\)</span> will give us deeper and narrower fixed effect.</p>
<p>Before running this model, we have to drop all other races. And <span class="math inline">\(\beta_1, \beta_2, \beta_3\)</span> are not collinear because there are all interaction terms with <span class="math inline">\(BTB_{mt}\)</span></p>
<p>If we just want to estimate the model for black men, we will modify it to be</p>
<p><span class="math display">\[
E_{imrt} = \alpha + BTB_{mt} \beta_1 + \delta_m + D_{imt} \beta_5 + \lambda_{rt} + (\delta_m \times f(t)) \beta_7 + e_{imrt}
\]</span></p>
<p><span class="math display">\[
E_{imrt} = \alpha + BTB_{m (t - 3t)} \theta_1 + BTB_{m(t-2)} \theta_2 + BTB_{mt} \theta_4 \\
+ BTB_{m(t+1)}\theta_5 + BTB_{m(t+2)}\theta_6 + BTB_{m(t+3t)}\theta_7 \\
+ [\delta_m + D_{imt}\beta_5 + \lambda_r + (\delta_m \times (f(t))\beta_7 + e_{imrt}]
\]</span></p>
<p>We have to leave <span class="math inline">\(BTB_{m(t-1)}\theta_3\)</span> out for the category would not be perfect collinearity</p>
<p>So the year before BTB (<span class="math inline">\(\theta_1, \theta_2, \theta_3\)</span>) should be similar to each other (i.e., same pre-trend). Remember, we only run for places with BTB.</p>
<p>If <span class="math inline">\(\theta_2\)</span> is statistically different from <span class="math inline">\(\theta_3\)</span> (baseline), then there could be a problem, but it could also make sense if we have pre-trend announcement.</p>
<p><br></p>
<p>Example by <a href="https://rpubs.com/phle/r_tutorial_difference_in_differences">Philipp Leppert</a> replicating <a href="https://davidcard.berkeley.edu/data_sets.html">Card and Krueger (1994)</a></p>
<p>Example by <a href="https://bookdown.org/aschmi11/causal_inf/difference-in-differences.html">Anthony Schmidt</a></p>
</div>
</div>
</div>
<div id="synthetic-control" class="section level2" number="20.3">
<h2>
<span class="header-section-number">20.3</span> Synthetic Control<a class="anchor" aria-label="anchor" href="#synthetic-control"><i class="fas fa-link"></i></a>
</h2>
<p>Synthetic control method (SCM) is a generalization of the dif-in-dif model</p>
<p>Advantages over dif-in-dif:</p>
<ol style="list-style-type: decimal">
<li>Maximization of the observable similarity between control and treatment (maybe also unobservables)</li>
<li>Can also be used in cases where no untreated case with similar on matching dimensions with treated cases</li>
<li>Objective selection of controls.</li>
</ol>
<p>a data driven procedure to construct more comparable control groups (i.e., black box).</p>
<p>To do causal inference with control and treatment group using <a href="quasi-experimental.html#matching-methods">Matching Methods</a>, you typically have to have similar covariates in the control and the treated groups. However, if you don’t methods like <a href="quasi-experimental.html#propensity-scores">Propensity Scores</a> and DID can perform rather poorly (i.e., large bias).</p>
<p>SCM is recommended when</p>
<ol style="list-style-type: decimal">
<li>Social events to evaluate large-scale program or policy</li>
<li>Only one treated case with several control candidates.</li>
</ol>
<p>Advantages:</p>
<ol style="list-style-type: decimal">
<li>From the selection criteria, researchers can understand the relative importance of each candidate</li>
<li>Post-intervention outcomes are not used in synthetic. Hence, you can’t retro-fit.</li>
<li>Observable similarity between control and treatment cases is maximized</li>
</ol>
<p><code>Synth</code> provides an algorithm that finds weighted combination of the comparison units where the weights are chosen such that it best resembles the values of predictors of the outcome variable for the affected units before the intervention.</p>
<div id="example-1-2" class="section level3" number="20.3.1">
<h3>
<span class="header-section-number">20.3.1</span> Example 1<a class="anchor" aria-label="anchor" href="#example-1-2"><i class="fas fa-link"></i></a>
</h3>
<p>by <a href="https://rpubs.com/danilofreire/synth">Danilo Freire</a></p>
<div class="sourceCode" id="cb1010"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("Synth")</span>
<span class="co"># install.packages("gsynth")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://www.stanford.edu/~jhain">"Synth"</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: package 'Synth' was built under R version 4.0.5</code></pre>
<div class="sourceCode" id="cb1012"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://yiqingxu.org/packages/gsynth/gsynth_examples.html">"gsynth"</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: package 'gsynth' was built under R version 4.0.5</code></pre>
<p>simulate data for 10 states and 30 years. State A receives the treatment <code>T = 20</code> after year 15.</p>
<div class="sourceCode" id="cb1014"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, <span class="fl">10</span><span class="op">)</span> 
<span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, each <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>
<span class="va">X1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">300</span>, mean <span class="op">=</span> <span class="fl">2</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="va">X2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="fl">300</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">300</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">300</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://amices.org/mice/reference/cbind.html">cbind</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">X1</span>, <span class="va">X2</span>, <span class="va">state</span>, <span class="va">year</span><span class="op">)</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">X1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">X1</span><span class="op">)</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">X2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">X2</span><span class="op">)</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">state.num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, each <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">state</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">`T`</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">state</span> <span class="op">==</span> <span class="st">"A"</span> <span class="op">&amp;</span> <span class="va">df</span><span class="op">$</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">15</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">state</span> <span class="op">==</span> <span class="st">"A"</span> <span class="op">&amp;</span> <span class="va">df</span><span class="op">$</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">15</span>, <span class="va">df</span><span class="op">$</span><span class="va">Y</span> <span class="op">+</span> <span class="fl">20</span>, <span class="va">df</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb1015"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></code></pre></div>
<pre><code>## 'data.frame':    300 obs. of  7 variables:
##  $ Y        : num  2.29 4.51 2.07 8.87 4.37 1.32 8 7.49 6.98 3.72 ...
##  $ X1       : num  1.37 2.18 1.16 3.6 2.33 1.18 2.49 2.74 2.58 1.69 ...
##  $ X2       : num  1.96 0.4 -0.75 -0.56 -0.45 1.06 0.51 -2.1 0 0.54 ...
##  $ state    : chr  "A" "A" "A" "A" ...
##  $ year     : num  1 2 3 4 5 6 7 8 9 10 ...
##  $ state.num: int  1 1 1 1 1 1 1 1 1 1 ...
##  $ T        : num  0 0 0 0 0 0 0 0 0 0 ...</code></pre>
<div class="sourceCode" id="cb1017"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataprep.out</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/dataprep.html">dataprep</a></span><span class="op">(</span>
        <span class="va">df</span>,
        predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X1"</span>, <span class="st">"X2"</span><span class="op">)</span>,
        dependent     <span class="op">=</span> <span class="st">"Y"</span>,
        unit.variable <span class="op">=</span> <span class="st">"state.num"</span>,
        time.variable <span class="op">=</span> <span class="st">"year"</span>,
        unit.names.variable <span class="op">=</span> <span class="st">"state"</span>,
        treatment.identifier  <span class="op">=</span> <span class="fl">1</span>,
        controls.identifier   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,
        time.predictors.prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">14</span><span class="op">)</span>,
        time.optimize.ssr     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">14</span><span class="op">)</span>,
        time.plot             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span>
    <span class="op">)</span>


<span class="va">synth.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/synth.html">synth</a></span><span class="op">(</span><span class="va">dataprep.out</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## X1, X0, Z1, Z0 all come directly from dataprep object.
## 
## 
## **************** 
##  searching for synthetic control unit  
##  
## 
## **************** 
## **************** 
## **************** 
## 
## MSPE (LOSS V): 9.831789 
## 
## solution.v:
##  0.3888387 0.6111613 
## 
## solution.w:
##  0.1115941 0.1832781 0.1027237 0.312091 0.06096758 0.03509706 0.05893735 0.05746256 0.07784853</code></pre>
<div class="sourceCode" id="cb1019"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">print</a></span><span class="op">(</span><span class="va">synth.tables</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/synth.tab.html">synth.tab</a></span><span class="op">(</span>
        dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,
        synth.res    <span class="op">=</span> <span class="va">synth.out</span><span class="op">)</span>
      <span class="op">)</span></code></pre></div>
<pre><code>## $tab.pred
##    Treated Synthetic Sample Mean
## X1   2.028     2.028       2.017
## X2   0.513     0.513       0.394
## 
## $tab.v
##    v.weights
## X1 0.389    
## X2 0.611    
## 
## $tab.w
##    w.weights unit.names unit.numbers
## 2      0.112          B            2
## 3      0.183          C            3
## 4      0.103          D            4
## 5      0.312          E            5
## 6      0.061          F            6
## 7      0.035          G            7
## 8      0.059          H            8
## 9      0.057          I            9
## 10     0.078          J           10
## 
## $tab.loss
##            Loss W   Loss V
## [1,] 9.761708e-12 9.831789</code></pre>
<div class="sourceCode" id="cb1021"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/Synth/man/path.plot.html">path.plot</a></span><span class="op">(</span>synth.res    <span class="op">=</span> <span class="va">synth.out</span>,
          dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,
          Ylab         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span>,
          Xlab         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span>,
          Legend       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"State A"</span>,<span class="st">"Synthetic State A"</span><span class="op">)</span>,
          Legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"topleft"</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v   <span class="op">=</span> <span class="fl">15</span>,
       lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-14-1.png" width="672"></div>
<p>Gaps plot:</p>
<div class="sourceCode" id="cb1022"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/Synth/man/gaps.plot.html">gaps.plot</a></span><span class="op">(</span>synth.res    <span class="op">=</span> <span class="va">synth.out</span>,
          dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,
          Ylab         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Gap"</span><span class="op">)</span>,
          Xlab         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span>,
          Ylim         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">30</span>, <span class="fl">30</span><span class="op">)</span>,
          Main         <span class="op">=</span> <span class="st">""</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v   <span class="op">=</span> <span class="fl">15</span>,
       lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-15-1.png" width="672"></div>
<p>Alternatively, <code>gsynth</code> provides options to estimate iterative fixed effects, and handle multiple treated units at tat time.</p>
<p>Here, we use two=way fixed effects and bootstrapped standard errors</p>
<div class="sourceCode" id="cb1023"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gsynth.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsynth/man/gsynth.html">gsynth</a></span><span class="op">(</span>
  <span class="va">Y</span> <span class="op">~</span> <span class="va">`T`</span> <span class="op">+</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span>,
  data <span class="op">=</span> <span class="va">df</span>,
  index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"year"</span><span class="op">)</span>,
  force <span class="op">=</span> <span class="st">"two-way"</span>,
  CV <span class="op">=</span> <span class="cn">TRUE</span>,
  r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>,
  se <span class="op">=</span> <span class="cn">TRUE</span>,
  inference <span class="op">=</span> <span class="st">"parametric"</span>,
  nboots <span class="op">=</span> <span class="fl">1000</span>,
  parallel <span class="op">=</span> <span class="cn">F</span> <span class="co"># TRUE</span>
<span class="op">)</span></code></pre></div>
<pre><code>## Cross-validating ... 
##  r = 0; sigma2 = 1.13533; IC = 0.95632; PC = 0.96713; MSPE = 1.65502
##  r = 1; sigma2 = 0.96885; IC = 1.54420; PC = 4.30644; MSPE = 1.33375
##  r = 2; sigma2 = 0.81855; IC = 2.08062; PC = 6.58556; MSPE = 1.27341*
##  r = 3; sigma2 = 0.71670; IC = 2.61125; PC = 8.35187; MSPE = 1.79319
##  r = 4; sigma2 = 0.62823; IC = 3.10156; PC = 9.59221; MSPE = 2.02301
##  r = 5; sigma2 = 0.55497; IC = 3.55814; PC = 10.48406; MSPE = 2.79596
## 
##  r* = 2
## 
## 
Simulating errors .............
Bootstrapping ...
## ..........</code></pre>
<div class="sourceCode" id="cb1025"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">gsynth.out</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-17-1.png" width="672"></div>
<div class="sourceCode" id="cb1026"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">gsynth.out</span>, type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-18-1.png" width="672"></div>
<div class="sourceCode" id="cb1027"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">gsynth.out</span>, type <span class="op">=</span> <span class="st">"counterfactual"</span>, raw <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span> <span class="co"># shows estimations for the control cases</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-19-1.png" width="672"></div>
</div>
<div id="example-2-1" class="section level3" number="20.3.2">
<h3>
<span class="header-section-number">20.3.2</span> Example 2<a class="anchor" aria-label="anchor" href="#example-2-1"><i class="fas fa-link"></i></a>
</h3>
<p>by <a href="https://towardsdatascience.com/causal-inference-using-synthetic-control-the-ultimate-guide-a622ad5cf827">Leihua Ye</a></p>
<div class="sourceCode" id="cb1028"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stanford.edu/~jhain">Synth</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"basque"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">basque</span><span class="op">)</span> <span class="co">#774*17</span></code></pre></div>
<pre><code>## [1] 774  17</code></pre>
<div class="sourceCode" id="cb1030"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">basque</span><span class="op">)</span></code></pre></div>
<pre><code>##   regionno     regionname year   gdpcap sec.agriculture sec.energy sec.industry
## 1        1 Spain (Espana) 1955 2.354542              NA         NA           NA
## 2        1 Spain (Espana) 1956 2.480149              NA         NA           NA
## 3        1 Spain (Espana) 1957 2.603613              NA         NA           NA
## 4        1 Spain (Espana) 1958 2.637104              NA         NA           NA
## 5        1 Spain (Espana) 1959 2.669880              NA         NA           NA
## 6        1 Spain (Espana) 1960 2.869966              NA         NA           NA
##   sec.construction sec.services.venta sec.services.nonventa school.illit
## 1               NA                 NA                    NA           NA
## 2               NA                 NA                    NA           NA
## 3               NA                 NA                    NA           NA
## 4               NA                 NA                    NA           NA
## 5               NA                 NA                    NA           NA
## 6               NA                 NA                    NA           NA
##   school.prim school.med school.high school.post.high popdens invest
## 1          NA         NA          NA               NA      NA     NA
## 2          NA         NA          NA               NA      NA     NA
## 3          NA         NA          NA               NA      NA     NA
## 4          NA         NA          NA               NA      NA     NA
## 5          NA         NA          NA               NA      NA     NA
## 6          NA         NA          NA               NA      NA     NA</code></pre>
<p>transform data to be used in <code><a href="https://rdrr.io/pkg/Synth/man/synth.html">synth()</a></code></p>
<div class="sourceCode" id="cb1032"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataprep.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/dataprep.html">dataprep</a></span><span class="op">(</span>
    foo <span class="op">=</span> <span class="va">basque</span>,
    predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
        <span class="st">"school.illit"</span>,
        <span class="st">"school.prim"</span>,
        <span class="st">"school.med"</span>,
        <span class="st">"school.high"</span>,
        <span class="st">"school.post.high"</span>,
        <span class="st">"invest"</span>
    <span class="op">)</span>,
    predictors.op <span class="op">=</span>  <span class="st">"mean"</span>,
    <span class="co"># the operator</span>
    time.predictors.prior <span class="op">=</span> <span class="fl">1964</span><span class="op">:</span><span class="fl">1969</span>,
    <span class="co">#the entire time frame from the #beginning to the end</span>
    special.predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"gdpcap"</span>, <span class="fl">1960</span><span class="op">:</span><span class="fl">1969</span>,  <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"sec.agriculture"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"sec.energy"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"sec.industry"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"sec.construction"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"sec.services.venta"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"sec.services.nonventa"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"popdens"</span>, <span class="fl">1969</span>,  <span class="st">"mean"</span><span class="op">)</span>
    <span class="op">)</span>,
    dependent <span class="op">=</span>  <span class="st">"gdpcap"</span>,
    <span class="co"># dv</span>
    unit.variable <span class="op">=</span>  <span class="st">"regionno"</span>,
    <span class="co">#identifying unit numbers</span>
    unit.names.variable <span class="op">=</span>  <span class="st">"regionname"</span>,
    <span class="co">#identifying unit names</span>
    time.variable <span class="op">=</span>  <span class="st">"year"</span>,
    <span class="co">#time-periods</span>
    treatment.identifier <span class="op">=</span> <span class="fl">17</span>,
    <span class="co">#the treated case</span>
    controls.identifier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">16</span>, <span class="fl">18</span><span class="op">)</span>,
    <span class="co">#the control cases; all others #except number 17</span>
    time.optimize.ssr <span class="op">=</span> <span class="fl">1960</span><span class="op">:</span><span class="fl">1969</span>,
    <span class="co">#the time-period over which to optimize</span>
    time.plot <span class="op">=</span> <span class="fl">1955</span><span class="op">:</span><span class="fl">1997</span>
<span class="op">)</span><span class="co">#the entire time period before/after the treatment</span></code></pre></div>
<p>where</p>
<ul>
<li><p>X1 = the control case before the treatment</p></li>
<li><p>X0 = the control cases after the treatment</p></li>
<li><p>Z1: the treatment case before the treatment</p></li>
<li><p>Z0: the treatment case after the treatment</p></li>
</ul>
<div class="sourceCode" id="cb1033"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">synth.out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/synth.html">synth</a></span><span class="op">(</span>data.prep.obj <span class="op">=</span> <span class="va">dataprep.out</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## X1, X0, Z1, Z0 all come directly from dataprep object.
## 
## 
## **************** 
##  searching for synthetic control unit  
##  
## 
## **************** 
## **************** 
## **************** 
## 
## MSPE (LOSS V): 0.008864606 
## 
## solution.v:
##  0.02773094 1.194e-07 1.60609e-05 0.0007163836 1.486e-07 0.002423908 0.0587055 0.2651997 0.02851006 0.291276 0.007994382 0.004053188 0.009398579 0.303975 
## 
## solution.w:
##  2.53e-08 4.63e-08 6.44e-08 2.81e-08 3.37e-08 4.844e-07 4.2e-08 4.69e-08 0.8508145 9.75e-08 3.2e-08 5.54e-08 0.1491843 4.86e-08 9.89e-08 1.162e-07</code></pre>
<p>Calculate the difference between the real basque region and the synthetic control</p>
<div class="sourceCode" id="cb1035"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gaps</span> <span class="op">=</span> <span class="va">dataprep.out</span><span class="op">$</span><span class="va">Y1plot</span> <span class="op">-</span> <span class="op">(</span><span class="va">dataprep.out</span><span class="op">$</span><span class="va">Y0plot</span> 
                                     <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="va">synth.out</span><span class="op">$</span><span class="va">solution.w</span><span class="op">)</span>
<span class="va">gaps</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span></code></pre></div>
<pre><code>##       1955       1956       1957 
## 0.15023473 0.09168035 0.03716475</code></pre>
<div class="sourceCode" id="cb1037"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">synth.tables</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/synth.tab.html">synth.tab</a></span><span class="op">(</span>dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,
                         synth.res <span class="op">=</span> <span class="va">synth.out</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">synth.tables</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "tab.pred" "tab.v"    "tab.w"    "tab.loss"</code></pre>
<div class="sourceCode" id="cb1039"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">synth.tables</span><span class="op">$</span><span class="va">tab.pred</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">13</span>,<span class="op">]</span></code></pre></div>
<pre><code>##                                          Treated Synthetic Sample Mean
## school.illit                              39.888   256.337     170.786
## school.prim                             1031.742  2730.104    1127.186
## school.med                                90.359   223.340      76.260
## school.high                               25.728    63.437      24.235
## school.post.high                          13.480    36.153      13.478
## invest                                    24.647    21.583      21.424
## special.gdpcap.1960.1969                   5.285     5.271       3.581
## special.sec.agriculture.1961.1969          6.844     6.179      21.353
## special.sec.energy.1961.1969               4.106     2.760       5.310
## special.sec.industry.1961.1969            45.082    37.636      22.425
## special.sec.construction.1961.1969         6.150     6.952       7.276
## special.sec.services.venta.1961.1969      33.754    41.104      36.528
## special.sec.services.nonventa.1961.1969    4.072     5.371       7.111</code></pre>
<p>Relative importance of each unit</p>
<div class="sourceCode" id="cb1041"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">synth.tables</span><span class="op">$</span><span class="va">tab.w</span><span class="op">[</span><span class="fl">8</span><span class="op">:</span><span class="fl">14</span>, <span class="op">]</span></code></pre></div>
<pre><code>##    w.weights            unit.names unit.numbers
## 9      0.000    Castilla-La Mancha            9
## 10     0.851              Cataluna           10
## 11     0.000  Comunidad Valenciana           11
## 12     0.000           Extremadura           12
## 13     0.000               Galicia           13
## 14     0.149 Madrid (Comunidad De)           14
## 15     0.000    Murcia (Region de)           15</code></pre>
<div class="sourceCode" id="cb1043"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the changes before and after the treatment </span>
<span class="fu"><a href="https://rdrr.io/pkg/Synth/man/path.plot.html">path.plot</a></span><span class="op">(</span>
    synth.res <span class="op">=</span> <span class="va">synth.out</span>,
    dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,
    Ylab <span class="op">=</span> <span class="st">"real per-capita gdp (1986 USD, thousand)"</span>,
    Xlab <span class="op">=</span> <span class="st">"year"</span>,
    Ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12</span><span class="op">)</span>,
    Legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Basque country"</span>,
               <span class="st">"synthetic Basque country"</span><span class="op">)</span>,
    Legend.position <span class="op">=</span> <span class="st">"bottomright"</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-26-1.png" width="672"></div>
<div class="sourceCode" id="cb1044"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/Synth/man/gaps.plot.html">gaps.plot</a></span><span class="op">(</span>
    synth.res <span class="op">=</span> <span class="va">synth.out</span>,
    dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,
    Ylab <span class="op">=</span>  <span class="st">"gap in real per - capita GDP (1986 USD, thousand)"</span>,
    Xlab <span class="op">=</span>  <span class="st">"year"</span>,
    Ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span><span class="op">)</span>,
    Main <span class="op">=</span> <span class="cn">NA</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-27-1.png" width="672"></div>
<p>Doubly Robust Difference-in-Differences</p>
<p>Example from <code>DRDID</code> package</p>
<div class="sourceCode" id="cb1045"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://pedrohcgs.github.io/DRDID/">DRDID</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: package 'DRDID' was built under R version 4.0.5</code></pre>
<div class="sourceCode" id="cb1047"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">nsw_long</span><span class="op">)</span>
<span class="co"># Form the Lalonde sample with CPS comparison group</span>
<span class="va">eval_lalonde_cps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html">subset</a></span><span class="op">(</span><span class="va">nsw_long</span>, <span class="va">nsw_long</span><span class="op">$</span><span class="va">treated</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">nsw_long</span><span class="op">$</span><span class="va">sample</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>Estimate Average Treatment Effect on Treated using Improved Locally Efficient Doubly Robust DID estimator</p>
<div class="sourceCode" id="cb1048"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://pedrohcgs.github.io/DRDID/reference/drdid.html">drdid</a></span><span class="op">(</span>
        yname <span class="op">=</span> <span class="st">"re"</span>,
        tname <span class="op">=</span> <span class="st">"year"</span>,
        idname <span class="op">=</span> <span class="st">"id"</span>,
        dname <span class="op">=</span> <span class="st">"experimental"</span>,
        xformla <span class="op">=</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">black</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span> <span class="va">hisp</span> <span class="op">+</span> <span class="va">re74</span>,
        data <span class="op">=</span> <span class="va">eval_lalonde_cps</span>,
        panel <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></code></pre></div>
<pre><code>##  Call:
## drdid(yname = "re", tname = "year", idname = "id", dname = "experimental", 
##     xformla = ~age + educ + black + married + nodegree + hisp + 
##         re74, data = eval_lalonde_cps, panel = TRUE)
## ------------------------------------------------------------------
##  Further improved locally efficient DR DID estimator for the ATT:
##  
##    ATT     Std. Error  t value    Pr(&gt;|t|)  [95% Conf. Interval] 
## -901.2703   393.6247   -2.2897     0.022    -1672.7747  -129.766 
## ------------------------------------------------------------------
##  Estimator based on panel data.
##  Outcome regression est. method: weighted least squares.
##  Propensity score est. method: inverse prob. tilting.
##  Analytical standard error.
## ------------------------------------------------------------------
##  See Sant'Anna and Zhao (2020) for details.</code></pre>
</div>
<div id="example-3" class="section level3" number="20.3.3">
<h3>
<span class="header-section-number">20.3.3</span> Example 3<a class="anchor" aria-label="anchor" href="#example-3"><i class="fas fa-link"></i></a>
</h3>
<p>by <code>Synth</code> package’s authors</p>
<div class="sourceCode" id="cb1050"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stanford.edu/~jhain">Synth</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"basque"</span><span class="op">)</span></code></pre></div>
<p><code><a href="https://rdrr.io/pkg/Synth/man/synth.html">synth()</a></code> requires</p>
<ul>
<li><p><span class="math inline">\(X_1\)</span> vector of treatment predictors</p></li>
<li><p><span class="math inline">\(X_0\)</span> matrix of same variables for control group</p></li>
<li><p><span class="math inline">\(Z_1\)</span> vector of outcome variable for treatment group</p></li>
<li><p><span class="math inline">\(Z_0\)</span> matrix of outcome variable for control group</p></li>
</ul>
<p>use <code><a href="https://rdrr.io/pkg/Synth/man/dataprep.html">dataprep()</a></code> to prepare data in the format that can be used throughout the <code>Synth</code> package</p>
<div class="sourceCode" id="cb1051"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dataprep.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/dataprep.html">dataprep</a></span><span class="op">(</span>
    foo <span class="op">=</span> <span class="va">basque</span>,
    predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
        <span class="st">"school.illit"</span>,
        <span class="st">"school.prim"</span>,
        <span class="st">"school.med"</span>,
        <span class="st">"school.high"</span>,
        <span class="st">"school.post.high"</span>,
        <span class="st">"invest"</span>
    <span class="op">)</span>,
    predictors.op <span class="op">=</span> <span class="st">"mean"</span>,
    time.predictors.prior <span class="op">=</span> <span class="fl">1964</span><span class="op">:</span><span class="fl">1969</span>,
    special.predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"gdpcap"</span>, <span class="fl">1960</span><span class="op">:</span><span class="fl">1969</span> , <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"sec.agriculture"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"sec.energy"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"sec.industry"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"sec.construction"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"sec.services.venta"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"sec.services.nonventa"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>,
        <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="st">"popdens"</span>, <span class="fl">1969</span>, <span class="st">"mean"</span><span class="op">)</span>
    <span class="op">)</span>,
    dependent <span class="op">=</span> <span class="st">"gdpcap"</span>,
    unit.variable <span class="op">=</span> <span class="st">"regionno"</span>,
    unit.names.variable <span class="op">=</span> <span class="st">"regionname"</span>,
    time.variable <span class="op">=</span> <span class="st">"year"</span>,
    treatment.identifier <span class="op">=</span> <span class="fl">17</span>,
    controls.identifier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">16</span>, <span class="fl">18</span><span class="op">)</span>,
    time.optimize.ssr <span class="op">=</span> <span class="fl">1960</span><span class="op">:</span><span class="fl">1969</span>,
    time.plot <span class="op">=</span> <span class="fl">1955</span><span class="op">:</span><span class="fl">1997</span>
<span class="op">)</span></code></pre></div>
<p>find optimal weights that identifies the synthetic control for the treatment group</p>
<div class="sourceCode" id="cb1052"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">synth.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/synth.html">synth</a></span><span class="op">(</span>data.prep.obj <span class="op">=</span> <span class="va">dataprep.out</span>, method <span class="op">=</span> <span class="st">"BFGS"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## X1, X0, Z1, Z0 all come directly from dataprep object.
## 
## 
## **************** 
##  searching for synthetic control unit  
##  
## 
## **************** 
## **************** 
## **************** 
## 
## MSPE (LOSS V): 0.008864606 
## 
## solution.v:
##  0.02773094 1.194e-07 1.60609e-05 0.0007163836 1.486e-07 0.002423908 0.0587055 0.2651997 0.02851006 0.291276 0.007994382 0.004053188 0.009398579 0.303975 
## 
## solution.w:
##  2.53e-08 4.63e-08 6.44e-08 2.81e-08 3.37e-08 4.844e-07 4.2e-08 4.69e-08 0.8508145 9.75e-08 3.2e-08 5.54e-08 0.1491843 4.86e-08 9.89e-08 1.162e-07</code></pre>
<div class="sourceCode" id="cb1054"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gaps</span> <span class="op">&lt;-</span> <span class="va">dataprep.out</span><span class="op">$</span><span class="va">Y1plot</span> <span class="op">-</span> <span class="op">(</span><span class="va">dataprep.out</span><span class="op">$</span><span class="va">Y0plot</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="va">synth.out</span><span class="op">$</span><span class="va">solution.w</span><span class="op">)</span>
<span class="va">gaps</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">]</span></code></pre></div>
<pre><code>##       1955       1956       1957 
## 0.15023473 0.09168035 0.03716475</code></pre>
<div class="sourceCode" id="cb1056"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">synth.tables</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/pkg/Synth/man/synth.tab.html">synth.tab</a></span><span class="op">(</span>dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>, synth.res <span class="op">=</span> <span class="va">synth.out</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">synth.tables</span><span class="op">)</span> <span class="co"># you can pick tables to see </span></code></pre></div>
<pre><code>## [1] "tab.pred" "tab.v"    "tab.w"    "tab.loss"</code></pre>
<div class="sourceCode" id="cb1058"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/Synth/man/path.plot.html">path.plot</a></span><span class="op">(</span>
    synth.res <span class="op">=</span> <span class="va">synth.out</span>,
    dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,
    Ylab <span class="op">=</span> <span class="st">"real per-capita GDP (1986 USD, thousand)"</span>,
    Xlab <span class="op">=</span> <span class="st">"year"</span>,
    Ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">12</span><span class="op">)</span>,
    Legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Basque country"</span>,
               <span class="st">"synthetic Basque country"</span><span class="op">)</span>,
    Legend.position <span class="op">=</span> <span class="st">"bottomright"</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-35-1.png" width="672"></div>
<div class="sourceCode" id="cb1059"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/Synth/man/gaps.plot.html">gaps.plot</a></span><span class="op">(</span>
    synth.res <span class="op">=</span> <span class="va">synth.out</span>,
    dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>,
    Ylab <span class="op">=</span> <span class="st">"gap in real per-capita GDP (1986 USD, thousand)"</span>,
    Xlab <span class="op">=</span> <span class="st">"year"</span>,
    Ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span><span class="op">)</span>,
    Main <span class="op">=</span> <span class="cn">NA</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-36-1.png" width="672"></div>
<p>You could also run placebo tests</p>
<p><br></p>
</div>
<div id="example-4" class="section level3" number="20.3.4">
<h3>
<span class="header-section-number">20.3.4</span> Example 4<a class="anchor" aria-label="anchor" href="#example-4"><i class="fas fa-link"></i></a>
</h3>
<p>by <a href="https://cran.r-project.org/web/packages/microsynth/vignettes/introduction.html">Michael Robbins and Steven Davenport</a> who are authors of <code>MicroSynth</code> with the following improvements:</p>
<ul>
<li><p>Standardization <code>use.survey = TRUE</code> and permutation ( <code>perm = 250</code> and <code>jack = TRUE</code> ) for placebo tests</p></li>
<li><p>Omnibus statistic (set to <code>omnibus.var</code> ) for multiple outcome variables</p></li>
<li><p>incorporate multiple follow-up periods <code>end.post</code></p></li>
</ul>
<p>Notes:</p>
<ul>
<li>
<p>Both predictors and outcome will be used to match units before intervention</p>
<ul>
<li><p>Outcome variable has to be <strong>time-variant</strong></p></li>
<li><p>Predictors are <strong>time-invariant</strong></p></li>
</ul>
</li>
<li>
</ul>
<div class="sourceCode" id="cb1060"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">microsynth</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: package 'microsynth' was built under R version 4.0.5</code></pre>
<div class="sourceCode" id="cb1062"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"seattledmi"</span><span class="op">)</span>

<span class="va">cov.var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TotalPop"</span>, <span class="st">"BLACK"</span>, <span class="st">"HISPANIC"</span>, <span class="st">"Males_1521"</span>, <span class="st">"HOUSEHOLDS"</span>, 
             <span class="st">"FAMILYHOUS"</span>, <span class="st">"FEMALE_HOU"</span>, <span class="st">"RENTER_HOU"</span>, <span class="st">"VACANT_HOU"</span><span class="op">)</span>
<span class="va">match.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"i_felony"</span>, <span class="st">"i_misdemea"</span>, <span class="st">"i_drugs"</span>, <span class="st">"any_crime"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb1063"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sea1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microsynth/man/microsynth.html">microsynth</a></span><span class="op">(</span>
    <span class="va">seattledmi</span>,
    idvar <span class="op">=</span> <span class="st">"ID"</span>,
    timevar <span class="op">=</span> <span class="st">"time"</span>,
    intvar <span class="op">=</span> <span class="st">"Intervention"</span>,
    start.pre <span class="op">=</span> <span class="fl">1</span>,
    end.pre <span class="op">=</span> <span class="fl">12</span>,
    end.post <span class="op">=</span> <span class="fl">16</span>,
    match.out <span class="op">=</span> <span class="va">match.out</span>, <span class="co"># outcome variable will be matched on exactly</span>
    match.covar <span class="op">=</span> <span class="va">cov.var</span>, <span class="co"># specify covariates will be matched on exactly</span>
    result.var <span class="op">=</span> <span class="va">match.out</span>, <span class="co"># used to report results</span>
    omnibus.var <span class="op">=</span> <span class="va">match.out</span>, <span class="co"># feature in the omnibus p-value</span>
    test <span class="op">=</span> <span class="st">"lower"</span>,
    n.cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>## Calculating weights...</code></pre>
<pre><code>## Created main weights for synthetic control: Time = 1.03</code></pre>
<pre><code>## Matching summary for main weights:</code></pre>
<pre><code>##               Targets Weighted.Control All.scaled
## Intercept          39          39.0002    39.0000
## TotalPop         2994        2994.0519  2384.7477
## BLACK             173         173.0010   190.5224
## HISPANIC          149         149.0026   159.2682
## Males_1521         49          49.0000    97.3746
## HOUSEHOLDS       1968        1968.0340  1113.5588
## FAMILYHOUS        519         519.0108   475.1876
## FEMALE_HOU        101         101.0010    81.1549
## RENTER_HOU       1868        1868.0203   581.9340
## VACANT_HOU        160         160.0115    98.4222
## i_felony.12        14          14.0000     4.9023
## i_felony.11        11          11.0002     4.6313
## i_felony.10         9           9.0000     3.0741
## i_felony.9          5           5.0000     3.2642
## i_felony.8         20          20.0000     4.4331
## i_felony.7          8           8.0000     3.7617
## i_felony.6         13          13.0000     3.0012
## i_felony.5         20          20.0007     3.1549
## i_felony.4         10          10.0000     4.0246
## i_felony.3          7           7.0000     3.3693
## i_felony.2         13          13.0002     3.2803
## i_felony.1         12          12.0000     3.4381
## i_misdemea.12      15          15.0002     4.2470
## i_misdemea.11      12          12.0000     4.6070
## i_misdemea.10      12          12.0000     4.0772
## i_misdemea.9       14          14.0000     3.7414
## i_misdemea.8       12          12.0000     3.9680
## i_misdemea.7       20          20.0000     4.2551
## i_misdemea.6       16          16.0005     3.5594
## i_misdemea.5       24          24.0000     3.5635
## i_misdemea.4       21          21.0002     4.3360
## i_misdemea.3       21          21.0000     4.3846
## i_misdemea.2       14          14.0000     3.5352
## i_misdemea.1       16          16.0000     4.1540
## i_drugs.12         13          13.0000     1.6543
## i_drugs.11          8           8.0000     1.5128
## i_drugs.10          3           3.0000     1.3227
## i_drugs.9           4           4.0000     0.9788
## i_drugs.8           4           4.0000     1.1123
## i_drugs.7          10          10.0000     1.0516
## i_drugs.6           4           4.0000     1.2377
## i_drugs.5           2           2.0000     1.2296
## i_drugs.4           1           1.0000     1.1245
## i_drugs.3           5           5.0000     1.3550
## i_drugs.2          12          12.0000     1.1366
## i_drugs.1           8           8.0002     1.3591
## any_crime.12      272         272.0012    65.3398
## any_crime.11      227         227.0017    64.2396
## any_crime.10      183         183.0010    55.6929
## any_crime.9       176         176.0005    53.2377
## any_crime.8       228         228.0005    55.8143
## any_crime.7       246         246.0024    55.8062
## any_crime.6       200         200.0010    52.8292
## any_crime.5       270         270.0014    50.6531
## any_crime.4       250         250.0010    57.2946
## any_crime.3       236         236.0010    58.8681
## any_crime.2       250         250.0012    51.5429
## any_crime.1       242         242.0010    55.1145
## 
## Calculation of weights complete: Total time = 1.68
## 
## Calculating basic statistics for end.post = 16...
## Completed calculation of basic statistics for end.post = 16.  Time = 3.22
## 
## Calculating survey statistics for end.post = 16...
## Completed survey statistics for main weights: Time = 5.51
## Completed calculation of survey statistics for end.post = 16.  Time = 5.51
## 
## microsynth complete: Overall time = 13.59</code></pre>
<div class="sourceCode" id="cb1068"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sea1</span></code></pre></div>
<pre><code>##  microsynth object
## 
## Scope:
##  Units:          Total: 9642 Treated: 39 Untreated: 9603
##  Study Period(s):    Pre-period: 1 - 12  Post-period: 13 - 16
##  Constraints:        Exact Match: 58     Minimized Distance: 0
## Time-variant outcomes:
##  Exact Match: i_felony, i_misdemea, i_drugs, any_crime (4)
##  Minimized Distance: (0)
## Time-invariant covariates:
##  Exact Match: TotalPop, BLACK, HISPANIC, Males_1521, HOUSEHOLDS, FAMILYHOUS, FEMALE_HOU, RENTER_HOU, VACANT_HOU (9)
##  Minimized Distance: (0)
## 
## Results:
## end.post = 16
##            Trt    Con Pct.Chng Linear.pVal Linear.Lower Linear.Upper
## i_felony    46  68.22   -32.6%      0.0109       -50.3%        -8.4%
## i_misdemea  45  71.80   -37.3%      0.0019       -52.8%       -16.7%
## i_drugs     20  23.76   -15.8%      0.2559       -46.4%        32.1%
## any_crime  788 986.44   -20.1%      0.0146       -32.9%        -4.9%
## Omnibus     --     --       --      0.0006           --           --</code></pre>
<div class="sourceCode" id="cb1070"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="va">sea1</span><span class="op">)</span></code></pre></div>
<pre><code>## Weight Balance Table: 
## 
##               Targets Weighted.Control   All.scaled
## Intercept          39        39.000239   39.0000000
## TotalPop         2994      2994.051921 2384.7476665
## BLACK             173       173.000957  190.5224020
## HISPANIC          149       149.002632  159.2682016
## Males_1521         49        49.000000   97.3746111
## HOUSEHOLDS       1968      1968.033976 1113.5588052
## FAMILYHOUS        519       519.010767  475.1876167
## FEMALE_HOU        101       101.000957   81.1549471
## RENTER_HOU       1868      1868.020338  581.9340386
## VACANT_HOU        160       160.011485   98.4222153
## i_felony.12        14        14.000000    4.9023024
## i_felony.11        11        11.000239    4.6313006
## i_felony.10         9         9.000000    3.0740510
## i_felony.9          5         5.000000    3.2641568
## i_felony.8         20        20.000000    4.4331052
## i_felony.7          8         8.000000    3.7616677
## i_felony.6         13        13.000000    3.0012446
## i_felony.5         20        20.000718    3.1549471
## i_felony.4         10        10.000000    4.0245800
## i_felony.3          7         7.000000    3.3693217
## i_felony.2         13        13.000239    3.2803360
## i_felony.1         12        12.000000    3.4380834
## i_misdemea.12      15        15.000239    4.2470442
## i_misdemea.11      12        12.000000    4.6070317
## i_misdemea.10      12        12.000000    4.0771624
## i_misdemea.9       14        14.000000    3.7414437
## i_misdemea.8       12        12.000000    3.9679527
## i_misdemea.7       20        20.000000    4.2551338
## i_misdemea.6       16        16.000479    3.5594275
## i_misdemea.5       24        24.000000    3.5634723
## i_misdemea.4       21        21.000239    4.3360299
## i_misdemea.3       21        21.000000    4.3845675
## i_misdemea.2       14        14.000000    3.5351587
## i_misdemea.1       16        16.000000    4.1540137
## i_drugs.12         13        13.000000    1.6543248
## i_drugs.11          8         8.000000    1.5127567
## i_drugs.10          3         3.000000    1.3226509
## i_drugs.9           4         4.000000    0.9788426
## i_drugs.8           4         4.000000    1.1123211
## i_drugs.7          10        10.000000    1.0516490
## i_drugs.6           4         4.000000    1.2377100
## i_drugs.5           2         2.000000    1.2296204
## i_drugs.4           1         1.000000    1.1244555
## i_drugs.3           5         5.000000    1.3550093
## i_drugs.2          12        12.000000    1.1365899
## i_drugs.1           8         8.000239    1.3590541
## any_crime.12      272       272.001196   65.3397635
## any_crime.11      227       227.001675   64.2395769
## any_crime.10      183       183.000957   55.6929060
## any_crime.9       176       176.000479   53.2377100
## any_crime.8       228       228.000479   55.8142502
## any_crime.7       246       246.002393   55.8061605
## any_crime.6       200       200.000957   52.8291848
## any_crime.5       270       270.001436   50.6530803
## any_crime.4       250       250.000957   57.2946484
## any_crime.3       236       236.000957   58.8680772
## any_crime.2       250       250.001196   51.5429371
## any_crime.1       242       242.000957   55.1144991
## 
## Results: 
## 
## end.post = 16
##            Trt    Con Pct.Chng Linear.pVal Linear.Lower Linear.Upper
## i_felony    46  68.22   -32.6%      0.0109       -50.3%        -8.4%
## i_misdemea  45  71.80   -37.3%      0.0019       -52.8%       -16.7%
## i_drugs     20  23.76   -15.8%      0.2559       -46.4%        32.1%
## any_crime  788 986.44   -20.1%      0.0146       -32.9%        -4.9%
## Omnibus     --     --       --      0.0006           --           --</code></pre>
<div class="sourceCode" id="cb1072"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/microsynth/man/plot_microsynth.html">plot_microsynth</a></span><span class="op">(</span><span class="va">sea1</span><span class="op">)</span></code></pre></div>
<p><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-39-1.png" width="672"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-39-2.png" width="672"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-39-3.png" width="672"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-39-4.png" width="672"></p>
<div class="sourceCode" id="cb1073"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sea2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microsynth/man/microsynth.html">microsynth</a></span><span class="op">(</span><span class="va">seattledmi</span>, 
                   idvar<span class="op">=</span><span class="st">"ID"</span>, timevar<span class="op">=</span><span class="st">"time"</span>, intvar<span class="op">=</span><span class="st">"Intervention"</span>, 
                   start.pre<span class="op">=</span><span class="fl">1</span>, end.pre<span class="op">=</span><span class="fl">12</span>, end.post<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">14</span>, <span class="fl">16</span><span class="op">)</span>,
                   match.out<span class="op">=</span><span class="va">match.out</span>, match.covar<span class="op">=</span><span class="va">cov.var</span>, 
                   result.var<span class="op">=</span><span class="va">match.out</span>, omnibus.var<span class="op">=</span><span class="va">match.out</span>, 
                   test<span class="op">=</span><span class="st">"lower"</span>, 
                   perm<span class="op">=</span><span class="fl">250</span>, jack<span class="op">=</span><span class="cn">TRUE</span>,
                   n.cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="selection-on-observables" class="section level2" number="20.4">
<h2>
<span class="header-section-number">20.4</span> Selection on observables<a class="anchor" aria-label="anchor" href="#selection-on-observables"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Example</strong></p>
<p><span class="citation"><a href="references.html#ref-aaronson2007" role="doc-biblioref">Aaronson, Barrow, and Sander</a> (<a href="references.html#ref-aaronson2007" role="doc-biblioref">2007</a>)</span></p>
<p>Do teachers qualifications (causally) affect student test scores?</p>
<p>Step 1:</p>
<p><span class="math display">\[
Y_{ijt} = \delta_0 + Y_{ij(t-1)} \delta_1 + X_{it} \delta_2 + Z_{jt} \delta_3 + \epsilon_{ijt}
\]</span></p>
<p>There can always be another variable</p>
<p>Any observable sorting is imperfect</p>
<p>Step 2:</p>
<p><span class="math display">\[
Y_{ijst} = \alpha_0 + Y_{ij(t-1)}\alpha_1 + X_{it} \alpha_2 + Z_{jt} \alpha_3 + \gamma_s + u_{isjt}
\]</span></p>
<ul>
<li><p><span class="math inline">\(\delta_3 &gt;0\)</span></p></li>
<li><p><span class="math inline">\(\delta_3 &gt; \alpha_3\)</span></p></li>
<li><p><span class="math inline">\(\gamma_s\)</span> = school fixed effect</p></li>
</ul>
<p>Sorting is less within school. Hence, we can introduce the school fixed effect</p>
<p>Step 3:</p>
<p>Find schools that look like they are putting students in class randomly (or as good as random) + we run step 2</p>
<p><span class="math display">\[
Y_{isjt} = Y_{isj(t-1)} \lambda + X_{it} \alpha_1 +Z_{jt} \alpha_{21}+ (Z_{jt} \times D_i)\alpha_{22}+ \gamma_5 + u_{isjt}
\]</span></p>
<ul>
<li><p><span class="math inline">\(D_{it}\)</span> is an element of <span class="math inline">\(X_{it}\)</span></p></li>
<li><p><span class="math inline">\(Z_{it}\)</span> = teacher experience</p></li>
</ul>
<p><span class="math display">\[
D_{it}=
\begin{cases}
1 &amp; \text{ if high poverty} \\
0 &amp; \text{otherwise}
\end{cases}
\]</span></p>
<p><span class="math inline">\(H_0:\)</span> <span class="math inline">\(\alpha_{22} = 0\)</span> test for effect heterogeneity whether the effect of teacher experience (<span class="math inline">\(Z_{jt}\)</span>) is different</p>
<ul>
<li><p>For low poverty is <span class="math inline">\(\alpha_{21}\)</span></p></li>
<li><p>For high poverty effect is <span class="math inline">\(\alpha_{21} + \alpha_{22}\)</span></p></li>
</ul>
<p><br></p>
</div>
<div id="matching-methods" class="section level2" number="20.5">
<h2>
<span class="header-section-number">20.5</span> Matching Methods<a class="anchor" aria-label="anchor" href="#matching-methods"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Motivation</strong></p>
<p>Effect of college quality on earnings</p>
<p>They ultimately estimate the treatment effect on the treated of attending a top (high ACT) versus bottom (low ACT) quartile college</p>
<p>Matching is <a href="quasi-experimental.html#selection-on-observables">Selection on observables</a> and only works if you have good observables.</p>
<p>Relative to <a href="linear-regression.html#ordinary-least-squares">OLS</a></p>
<ol style="list-style-type: decimal">
<li>Matching makes the <strong>common support</strong> explicit (and changes default from “ignore” to “enforce”)</li>
<li>Relaxes linear function form. Thus, less parametric.</li>
</ol>
<p>It also helps if you have high ratio of controls to treatments.</p>
<p><br></p>
<p>For detail summary <span class="citation">(<a href="references.html#ref-Stuart_2010" role="doc-biblioref">Stuart 2010</a>)</span></p>
<p>Matching is defined as “any method that aims to equate (or”balance“) the distribution of covariates in the treated and control groups.” <span class="citation">(<a href="references.html#ref-Stuart_2010" role="doc-biblioref">Stuart 2010, 1</a>)</span></p>
<p>Equivalently, matching is a selection on observables identifications strategy.</p>
<p><strong>If you think your OLS estimate is biased, a matching estimate (almost surely) is too.</strong></p>
<p>Unconditionally, consider</p>
<p><span class="math display">\[
E(Y_i^T | T) - E(Y_i^C |C) + E(Y_i^C | T) - E(Y_i^C | T) \\
= E(Y_i^T - Y_i^C | T) + [E(Y_i^C | T) - E(Y_i^C |C)] \\
= E(Y_i^T - Y_i^C | T) + \text{selection bias}
\]</span></p>
<p>where <span class="math inline">\(E(Y_i^T - Y_i^C | T)\)</span> is the causal inference that we want to know.</p>
<p>Randomization eliminates the selection bias.</p>
<p>If we don’t have randomization, then <span class="math inline">\(E(Y_i^C | T) \neq E(Y_i^C |C)\)</span></p>
<p>Matching tries to do selection on observables <span class="math inline">\(E(Y_i^C | X, T) = E(Y_i^C|X, C)\)</span></p>
<p><a href="quasi-experimental.html#propensity-scores">Propensity Scores</a> basically do <span class="math inline">\(E(Y_i^C| P(X) , T) = E(Y_i^C | P(X), C)\)</span></p>
<p><strong>Matching standard errors will exceed OLS standard errors</strong></p>
<p>The treatment should have larger predictive power than the control because you use treatment to pick control (not control to pick treatment).</p>
<p>The average treatment effect (ATE) is</p>
<p><span class="math display">\[
\frac{1}{N_T} \sum_{i=1}^{N_T} (Y_i^T - \frac{1}{N_{C_T}} \sum_{i=1}^{N_{C_T}} Y_i^C)
\]</span></p>
<p>Since there is no closed-form solution for the standard error of the average treatment effect, we have to use bootstrapping to get standard error.</p>
<p><br></p>
<p>Professor Gary King advocates instead of using the word “matching,” we should use “<strong>pruning</strong>” (i.e., deleting observations). It is a preprocessing step where it prunes nonmatches to make control variables less important in your analysis.</p>
<p>Without Matching</p>
<ul>
<li>
<strong>Imbalance data</strong> leads to <strong>model dependence</strong> lead to a lot of <strong>researcher discretion</strong> leads to <strong>bias</strong>
</li>
</ul>
<p>With Matching</p>
<ul>
<li>We have balance data which essentially erase human discretion</li>
</ul>
<div class="inline-table"><table class="table table-sm">
<caption>Table @ref(tab:Gary King - International Methods Colloquium talk 2015)</caption>
<thead><tr class="header">
<th>Balance Covariates</th>
<th>Complete Randomization</th>
<th>Fully Exact</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Observed</td>
<td>On average</td>
<td>Exact</td>
</tr>
<tr class="even">
<td>Unobserved</td>
<td>On average</td>
<td>On average</td>
</tr>
</tbody>
</table></div>
<p>Fully blocked is superior on</p>
<ul>
<li><p>imbalance</p></li>
<li><p>model dependence</p></li>
<li><p>power</p></li>
<li><p>efficiency</p></li>
<li><p>bias</p></li>
<li><p>research costs</p></li>
<li><p>robustness</p></li>
</ul>
<p>Matching is used when</p>
<ul>
<li><p>Outcomes are not available to select subjects for follow-up</p></li>
<li><p>Outcomes are available to improve precision of the estimate (i.e., reduce bias)</p></li>
</ul>
<p>Hence, we can only observe one outcome of a unit (either treated or control), we can think of this problem as missing data as well. Thus, this section is closely related to <a href="imputation-missing-data.html#imputation-missing-data">Imputation (Missing Data)</a></p>
<p>In observational studies, we cannot randomize the treatment effect. Subjects select their own treatments, which could introduce selection bias (i.e., systematic differences between group differences that confound the effects of response variable differences).</p>
<p><br></p>
<p>Matching is used to</p>
<ul>
<li><p>reduce model dependence</p></li>
<li><p>diagnose balance in the dataset</p></li>
</ul>
<p>Assumptions of matching:</p>
<ol style="list-style-type: decimal">
<li>
<p>treatment assignment is independent of potential outcomes given the covariates</p>
<ul>
<li><p><span class="math inline">\(T \perp (Y(0),Y(1))|X\)</span></p></li>
<li><p>known as ignorability, or ignorable, no hidden bias, or unconfounded.</p></li>
<li>
<p>You typically satisfy this assumption when unobserved covariates correlated with observed covariates.</p>
<ul>
<li>But when unobserved covariates are unrelated to the observed covariates, you can use sensitivity analysis to check your result, or use “design sensitivity” <span class="citation">(<a href="references.html#ref-Heller_2009" role="doc-biblioref">Heller, Rosenbaum, and Small 2009</a>)</span>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>positive probability of receiving treatment for all X</p>
<ul>
<li><span class="math inline">\(0 &lt; P(T=1|X)&lt;1 \forall X\)</span></li>
</ul>
</li>
<li>
<p>Stable Unit Treatment value Assumption (SUTVA)</p>
<ul>
<li>
<p>Outcomes of A are not affected by treatment of B.</p>
<ul>
<li>Very hard in cases where there is “spillover” effects (interactions between control and treatment). To combat, we need to reduce interactions.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>Generalization</p>
<ul>
<li><p><span class="math inline">\(P_t\)</span>: treated population -&gt; <span class="math inline">\(N_t\)</span>: random sample from treated</p></li>
<li><p><span class="math inline">\(P_c\)</span>: control population -&gt; <span class="math inline">\(N_c\)</span>: random sample from control</p></li>
<li><p><span class="math inline">\(\mu_i\)</span> = means ; <span class="math inline">\(\Sigma_i\)</span> = variance covariance matrix of the <span class="math inline">\(p\)</span> covariates in group i (<span class="math inline">\(i = t,c\)</span>)</p></li>
<li><p><span class="math inline">\(X_j\)</span> = <span class="math inline">\(p\)</span> covariates of individual <span class="math inline">\(j\)</span></p></li>
<li><p><span class="math inline">\(T_j\)</span> = treatment assignment</p></li>
<li><p><span class="math inline">\(Y_j\)</span> = observed outcome</p></li>
<li><p>Assume: <span class="math inline">\(N_t &lt; N_c\)</span></p></li>
<li>
<p>Treatment effect is <span class="math inline">\(\tau(x) = R_1(x) - R_0(x)\)</span> where</p>
<ul>
<li><p><span class="math inline">\(R_1(x) = E(Y(1)|X)\)</span></p></li>
<li><p><span class="math inline">\(R_0(x) = E(Y(0)|X)\)</span></p></li>
</ul>
</li>
<li>
<p>Assume: parallel trends hence <span class="math inline">\(\tau(x) = \tau \forall x\)</span></p>
<ul>
<li>If the parallel trends are not assumed, an average effect can be estimated.</li>
</ul>
</li>
<li>
<p>Common estimands:</p>
<ul>
<li><p>Average effect of the treatment on the treated (ATT): effects on treatment group</p></li>
<li><p>Average treatment effect (ATE): effect on both treatment and control</p></li>
</ul>
</li>
</ul>
<p>Steps:</p>
<ol style="list-style-type: decimal">
<li>
<p>Define “closeness”: decide distance measure to be used</p>
<ol style="list-style-type: decimal">
<li>
<p>Which variables to include:</p>
<ol style="list-style-type: decimal">
<li>
<p>Ignorability (no unobserved differences between treatment and control)</p>
<ol style="list-style-type: decimal">
<li><p>Since cost of including unrelated variables is small, you should include as many as possible (unless sample size/power doesn’t allow you to because of increased variance)</p></li>
<li><p>Do not include variables that were affected by the treatment.</p></li>
<li><p>Note: if a matching variable (i.e., heavy drug users) is highly correlated to the outcome variable (i.e., heavy drinkers) , you will be better to exclude it in the matching set.</p></li>
</ol>
</li>
</ol>
</li>
<li><p>Which distance measures: more below</p></li>
</ol>
</li>
<li>
<p>Matching methods</p>
<ol style="list-style-type: decimal">
<li>
<p>Nearest neighbor matching</p>
<ol style="list-style-type: decimal">
<li><p>Simple (greedy) matching: performs poorly when there is competition for controls.</p></li>
<li><p>Optimal matching: considers global distance measure</p></li>
<li><p>Ratio matching: to combat increase bias and reduced variation when you have k:1 matching, one can use approximations by Rubin and Thomas (1996).</p></li>
<li><p>With or without replacement: with replacement is typically better, but one needs to account for dependent in the matched sample when doing later analysis (can use frequency weights to combat).</p></li>
</ol>
</li>
<li>
<p>Subclassification, Full Matching and Weighting</p>
<p>Neareast neighbor matching assign is 0 (control) or 1 (treated), while these methods use weights between 0 and 1.</p>
<ol style="list-style-type: decimal">
<li><p>Subclassification: distribution into multiple subclass (e.g., 5-10)</p></li>
<li><p>Full matching: optimal ly minimize the average of the distances between each treated unit and each control unit within each matched set.</p></li>
<li>
<p>Weighting adjustments: weighting technique uses propensity scores to estimate ATE. If the weights are extreme, the variance can be large not due to the underlying probabilities, but due to the estimation procure. To combat this, use (1) weight trimming, or (2) doubly -robust methods when propensity scores are used for weighing or matching.</p>
<ol style="list-style-type: decimal">
<li><p>Inverse probability of treatment weighting (IPTW) <span class="math inline">\(w_i = \frac{T_i}{\hat{e}_i} + \frac{1 - T_i}{1 - \hat{e}_i}\)</span></p></li>
<li><p>Odds <span class="math inline">\(w_i = T_i + (1-T_i) \frac{\hat{e}_i}{1-\hat{e}_i}\)</span></p></li>
<li><p>Kernel weighting (e.g., in economics) averages over multiple units in the control group.</p></li>
</ol>
</li>
</ol>
</li>
<li>
<p>Assessing Common Support</p>
<ul>
<li>common support means overlapping of the propensity score distributions in the treatment and control groups. Propensity score is used to discard control units from the common support. Alternatively, convex hull of the covariates in the multi-dimensional space.</li>
</ul>
</li>
</ol>
</li>
<li>
<p>Assessing the quality of matched samples (Diagnose)</p>
<ul>
<li>
<p>Balance = similarity of the empirical distribution of the full set of covariates in the matched treated and control groups. Equivalently, treatment is unrelated to the covariates</p>
<ul>
<li>
<span class="math inline">\(\tilde{p}(X|T=1) = \tilde{p}(X|T=0)\)</span> where <span class="math inline">\(\tilde{p}\)</span> is the empirical distribution.</li>
</ul>
</li>
<li>
<p>Numerical Diagnostics</p>
<ol style="list-style-type: decimal">
<li><p>standardized difference in means of each covariate (most common), also known as“standardized bias,” “standardized difference in means.”</p></li>
<li><p>standardized difference of means of the propensity score (should be &lt; 0.25) <span class="citation">(<a href="references.html#ref-Rubin_2001" role="doc-biblioref">Rubin 2001</a>)</span></p></li>
<li><p>ratio of the variances of the propensity score in the treated and control groups (should be between 0.5 and 2). <span class="citation">(<a href="references.html#ref-Rubin_2001" role="doc-biblioref">Rubin 2001</a>)</span></p></li>
<li>
<p>For each covariate, the ratio fo the variance of the residuals orthogonal to the propensity score in the treated and control groups.</p>
<p>Note: can’t use hypothesis tests or p-values because of (1) in-sample property (not population), (2) conflation of changes in balance with changes in statistical power.</p>
</li>
</ol>
</li>
<li>
<p>Graphical Diagnostics</p>
<ul>
<li><p>QQ plots</p></li>
<li><p>Empirical Distribution Plot</p></li>
</ul>
</li>
</ul>
</li>
<li>
<p>Estimate the treatment effect</p>
<ol style="list-style-type: decimal">
<li>
<p>After k:1</p>
<ol style="list-style-type: decimal">
<li>Need to account for weights when use matching with replacement.</li>
</ol>
</li>
<li>
<p>After Subclassification and Full Matching</p>
<ol style="list-style-type: decimal">
<li><p>weighting the subclass estimates by the number of treated units in each subclass for ATT</p></li>
<li><p>WEighting by the overall number of individual in each subclass for ATE.</p></li>
</ol>
</li>
<li><p>Variance estimation: should incorporate uncertainties in both the matching procedure (step 3) and the estimation procedure (step 4)</p></li>
</ol>
</li>
</ol>
<p><br></p>
<p>Notes:</p>
<ul>
<li><p>With missing data, use generalized boosted models, or multiple imputation <span class="citation">(<a href="references.html#ref-Qu_2009" role="doc-biblioref">Qu and Lipkovich 2009</a>)</span></p></li>
<li>
<p>Violation of ignorable treatment assignment (i.e., unobservables affect treatment and outcome). control by</p>
<ul>
<li><p>measure pre-treatment measure of the outcome variable</p></li>
<li><p>find the difference in outcomes between multiple control groups. If there is a significant difference, there is evidence for violation.</p></li>
<li><p>find the range of correlations between unobservables and both treatment assignment and outcome to nullify the significant effect.</p></li>
</ul>
</li>
<li>
<p>Choosing between methods</p>
<ul>
<li><p>smallest standardized difference of mean across the largest number of covariates</p></li>
<li><p>minimize the standardized difference of means of a few particularly prognostic covariates</p></li>
<li><p>fest number of large standardized difference of means (&gt; 0.25)</p></li>
<li><p><span class="citation">(<a href="references.html#ref-Diamond_2013" role="doc-biblioref">Diamond and Sekhon 2013</a>)</span> automates the process</p></li>
</ul>
</li>
<li>
<p>In practice</p>
<ul>
<li><p>If ATE, ask if there is enough overlap of the treated and control groups’ propensity score to estimate ATE, if not use ATT instead</p></li>
<li><p>If ATT, ask if there are controls across the full range of the treated group</p></li>
</ul>
</li>
<li>
<p>Choose matching method</p>
<ul>
<li><p>If ATE, use IPTW or full matching</p></li>
<li><p>If ATT, and more controls than treated (at least 3 times), k:1 nearest neighbor without replacement</p></li>
<li><p>If ATT, and few controls , use subclassification, full matching, and weighting by the odds</p></li>
</ul>
</li>
<li>
<p>Diagnostic</p>
<ul>
<li><p>If balance, use regression on matched samples</p></li>
<li><p>If imbalance on few covariates, treat them with Mahalanobis</p></li>
<li><p>If imbalance on many covariates, try k:1 matching with replacement</p></li>
</ul>
</li>
</ul>
<p>Ways to define the distance <span class="math inline">\(D_{ij}\)</span></p>
<ol style="list-style-type: decimal">
<li>Exact</li>
</ol>
<p><span class="math display">\[
D_{ij} = 
\begin{cases}
0, \text{ if } X_i = X_j, \\
\infty, \text{ if } X_i \neq X_j
\end{cases}
\]</span></p>
<p>An advanced is <a href="quasi-experimental.html#coarsened-exact-matching">Coarsened Exact Matching</a></p>
<ol start="2" style="list-style-type: decimal">
<li>Mahalanobis</li>
</ol>
<p><span class="math display">\[
D_{ij} = (X_i - X_j)'\Sigma^{-1} (X_i - X_j)
\]</span></p>
<p>where</p>
<p><span class="math inline">\(\Sigma\)</span> = variance covariance matrix of X in the</p>
<ul>
<li><p>control group if ATT is interested</p></li>
<li><p>polled treatment and control groups if ATE is interested</p></li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Propensity score:</li>
</ol>
<p><span class="math display">\[
D_{ij} = |e_i - e_j|
\]</span></p>
<p>where <span class="math inline">\(e_k\)</span> = the propensity score for individual k</p>
<p>An advanced is Prognosis score <span class="citation">(<a href="references.html#ref-Hansen_2008" role="doc-biblioref">Hansen 2008</a>)</span>, but you have to know (i.e., specify) the relationship between the covariates and outcome.</p>
<ol start="4" style="list-style-type: decimal">
<li>Linear propensity score</li>
</ol>
<p><span class="math display">\[
D_{ij} = |logit(e_i) - logit(e_j)|
\]</span></p>
<p>The exact and Mahalanobis are not good in high dimensional or non normally distributed X’s cases.</p>
<p>We can combine Mahalanobis matching with propensity score calipers <span class="citation">(<a href="references.html#ref-Rubin_2000" role="doc-biblioref">Rubin and Thomas 2000</a>)</span></p>
<p>Other advanced methods for longitudinal settings</p>
<ul>
<li><p>marginal structural models <span class="citation">(<a href="references.html#ref-Robins_2000" role="doc-biblioref">Robins, Hernán, and Brumback 2000</a>)</span></p></li>
<li><p>balanced risk set matching <span class="citation">(<a href="references.html#ref-Li_2001" role="doc-biblioref">Li, Propert, and Rosenbaum 2001</a>)</span></p></li>
</ul>
<p><br>
Most matching methods are based on (ex-post)</p>
<ul>
<li><p>propensity score</p></li>
<li><p>distance metric</p></li>
<li><p>covariates</p></li>
</ul>
<p>Packages</p>
<ul>
<li><p><code>cem</code> Coarsened exact matching</p></li>
<li><p><code>Matching</code> Multivariate and propensity score matching with balance optimization</p></li>
<li><p><code>MatchIt</code> Nonparametric preprocessing for parametric causal inference. Have nearest neighbor, Mahalanobis, caliper, exact, full, optimal, subclassification</p></li>
<li><p><code>MatchingFrontier</code> optimize balance and sample size <span class="citation">(<a href="references.html#ref-King_2016" role="doc-biblioref">G. King, Lucas, and Nielsen 2016</a>)</span></p></li>
<li><p><code>optmatch</code>optimal matching with variable ratio, optimal and full matching</p></li>
<li><p><code>PSAgraphics</code> Propensity score graphics</p></li>
<li><p><code>rbounds</code> sensitivity analysis with matched data, examine ignorable treatment assignment assumption</p></li>
<li><p><code>twang</code> weighting and analysis of non-equivalent groups</p></li>
<li><p><code>CBPS</code> covariate balancing propensity score. Can also be used in the longitudinal setting with marginal structural models.</p></li>
<li><p><code>PanelMatch</code> based on <a href="https://imai.fas.harvard.edu/research/files/tscs.pdf">Imai, Kim, and Wang (2018)</a></p></li>
</ul>
<p><br></p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="62%">
<col width="37%">
</colgroup>
<thead><tr class="header">
<th>Matching</th>
<th>Regression</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Not as sensitive to the functional form of the covariates</td>
<td>can estimate the effect of a continuous treatment</td>
</tr>
<tr class="even">
<td>
<p>Easier to asses whether it’s working</p>
<p>Easier to explain</p>
<p>allows a nice visualization of an evaluation</p>
</td>
<td>estimate the effect of all the variables (not just the treatment)</td>
</tr>
<tr class="odd">
<td>If you treatment is fairly rare, you may have a lot of control observations that are obviously no comparable</td>
<td>can estimate interactions of treatment with covariates</td>
</tr>
<tr class="even">
<td>Less parametric</td>
<td>More parametric</td>
</tr>
<tr class="odd">
<td>Enforces common support (i.e., space where treatment and control have the same characteristics)</td>
<td></td>
</tr>
</tbody>
</table></div>
<p>However, the problem of <strong>omitted variables</strong> (i.e., those that affect both the outcome and whether observation was treated) - unobserved confounders is still present in matching methods.</p>
<p><br></p>
<p>Difference between matching and regression following Jorn-Ste§en Pischke’s <a href="https://econ.lse.ac.uk/staff/spischke/ec533/regression%20vs%20matching.pdf">lecture</a></p>
<p>Suppose we want to estimate the effect of treatment on the treated</p>
<p><span class="math display">\[
\begin{aligned}
\delta_{TOT} &amp;= E[ Y_{1i} - Y_{0i} | D_i = 1 ] \\
&amp;= E\{E[Y_{1i} | X_i, D_i = 1] - E[Y_{0i}|X_i, D_i = 1]|D_i = 1\} &amp;&amp; \text{law of itereated expectations}
\end{aligned}
\]</span></p>
<p>Under conditional independence</p>
<p><span class="math display">\[
E[Y_{0i} |X_i , D_i = 0 ] = E[Y_{0i} | X_i, D_i = 1]
\]</span></p>
<p>then</p>
<p><span class="math display">\[
\begin{aligned}
\delta_{TOT} &amp;= E \{ E[ Y_{1i} | X_i, D_i = 1] - E[ Y_{0i}|X_i, D_i = 0 ]|D_i = 1\} \\
&amp;= E\{E[y_i | X_i, D_i = 1] - E[y_i |X_i, D_i = 0 ] | D_i = 1\} \\
&amp;= E[\delta_X |D_i = 1]
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(\delta_X\)</span> is an X-specific difference in means at covariate value <span class="math inline">\(X_i\)</span></p>
<p>When <span class="math inline">\(X_i\)</span> is discrete, the matching estimand is</p>
<p><span class="math display">\[
\delta_M = \sum_x \delta_x P(X_i = x |D_i = 1)
\]</span></p>
<p>where <span class="math inline">\(P(X_i = x |D_i = 1)\)</span> is the probability mass function for <span class="math inline">\(X_i\)</span> given <span class="math inline">\(D_i = 1\)</span></p>
<p>According to Bayes rule,</p>
<p><span class="math display">\[
P(X_i = x | D_i = 1) = \frac{P(D_i = 1 | X_i = x) \times P(X_i = x)}{P(D_i = 1)}
\]</span></p>
<p>hence,</p>
<p><span class="math display">\[
\begin{aligned}
\delta_M &amp;= \frac{\sum_x \delta_x P (D_i = 1 | X_i = x) P (X_i = x)}{\sum_x P(D_i = 1 |X_i = x)P(X_i = x)} \\
&amp;= \sum_x \delta_x \frac{ P (D_i = 1 | X_i = x) P (X_i = x)}{\sum_x P(D_i = 1 |X_i = x)P(X_i = x)}
\end{aligned}
\]</span></p>
<p>On the other hand, suppose we have regression</p>
<p><span class="math display">\[
y_i = \sum_x d_{ix} \beta_x + \delta_R D_i + \epsilon_i
\]</span></p>
<p>where</p>
<ul>
<li><p><span class="math inline">\(d_{ix}\)</span> = dummy that indicates <span class="math inline">\(X_i = x\)</span></p></li>
<li><p><span class="math inline">\(\beta_x\)</span> = regression-effect for <span class="math inline">\(X_i = x\)</span></p></li>
<li><p><span class="math inline">\(\delta_R\)</span> = regression estimand where</p></li>
</ul>
<p><span class="math display">\[
\begin{aligned}
\delta_R &amp;= \frac{\sum_x \delta_x [P(D_i = 1 | X_i = x) (1 - P(D_i = 1 | X_i = x))]P(X_i = x)}{\sum_x [P(D_i = 1| X_i = x)(1 - P(D_i = 1 | X_i = x))]P(X_i = x)} \\
&amp;= \sum_x \delta_x \frac{[P(D_i = 1 | X_i = x) (1 - P(D_i = 1 | X_i = x))]P(X_i = x)}{\sum_x [P(D_i = 1| X_i = x)(1 - P(D_i = 1 | X_i = x))]P(X_i = x)}
\end{aligned}
\]</span></p>
<p>the difference between the regression and matching estimand is the weights they use to combine the covariate specific treatment effect <span class="math inline">\(\delta_x\)</span></p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="2%">
<col width="17%">
<col width="44%">
<col width="35%">
</colgroup>
<thead><tr class="header">
<th>Type</th>
<th>uses weights which depend on</th>
<th>interpretation</th>
<th>makes sense because</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Matching</td>
<td>
<p><span class="math inline">\(P(D_i = 1|X_i = x)\)</span></p>
<p>the fraction of treated observations in a covariate cell (i.e., or the mean of <span class="math inline">\(D_i\)</span>)</p>
</td>
<td>This is larger in cells with many treated observations.</td>
<td>we want the effect of treatment on the treated</td>
</tr>
<tr class="even">
<td>Regression</td>
<td>
<p><span class="math inline">\(P(D_i = 1 |X_i = x)(1 - P(D_i = 1| X_i ))\)</span></p>
<p>the variance of <span class="math inline">\(D_i\)</span> in the covariate cell</p>
</td>
<td>This weight is largest in cells where there are half treated and half untreated observations. (this is the reason why we want to treat our sample so it is balanced, before running regular regression model, as mentioned above).</td>
<td>these cells will produce the lowest variance estimates of <span class="math inline">\(\delta_x\)</span>. If all the <span class="math inline">\(\delta_x\)</span> are the same, the most efficient estimand uses the lowest variance cells most heavily.</td>
</tr>
</tbody>
</table></div>
<p>The goal of matching is to produce covariate balance (i.e., distributions of covariates in treatment and control groups are approximately similar as they would be in a successful randomized experiment).</p>
<div id="matchit" class="section level3" number="20.5.1">
<h3>
<span class="header-section-number">20.5.1</span> MatchIt<a class="anchor" aria-label="anchor" href="#matchit"><i class="fas fa-link"></i></a>
</h3>
<p>Procedure typically involves (proposed by <a href="https://cran.r-project.org/web/packages/MatchIt/vignettes/MatchIt.html">Noah Freifer</a> using <code>MatchIt</code>)</p>
<ol style="list-style-type: decimal">
<li>planning</li>
<li>matching</li>
<li>checking (balance)</li>
<li>estimating the treatment effect</li>
</ol>
<div class="sourceCode" id="cb1074"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://kosukeimai.github.io/MatchIt/">MatchIt</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: package 'MatchIt' was built under R version 4.0.5</code></pre>
<div class="sourceCode" id="cb1076"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"lalonde"</span><span class="op">)</span></code></pre></div>
<p>examine <code>treat</code> on <code>re78</code></p>
<ol style="list-style-type: decimal">
<li>Planning</li>
</ol>
<ul>
<li><p>select type of effect to be estimated (e.g., mediation effect, conditional effect, marginal effect)</p></li>
<li><p>select the target population</p></li>
<li><p>select variables to match/balance <span class="citation">(<a href="references.html#ref-Austin_2011" role="doc-biblioref">Austin 2011</a>)</span> <span class="citation">(<a href="references.html#ref-VanderWeele_2019" role="doc-biblioref">VanderWeele 2019</a>)</span></p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Check Initial Imbalance</li>
</ol>
<div class="sourceCode" id="cb1077"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># No matching; constructing a pre-match matchit object</span>
<span class="va">m.out0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span>
    <span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span>
        <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>,
    data <span class="op">=</span> <span class="va">lalonde</span>,
    method <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># assess balance before matching</span>
    distance <span class="op">=</span> <span class="st">"glm"</span> <span class="co"># logistic regression</span>
<span class="op">)</span>

<span class="co"># Checking balance prior to matching</span>
<span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="va">m.out0</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
## matchit(formula = treat ~ age + educ + race + married + nodegree + 
##     re74 + re75, data = lalonde, method = NULL, distance = "glm")
## 
## Summary of Balance for All Data:
##            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
## distance          0.5774        0.1822          1.7941     0.9211    0.3774
## age              25.8162       28.0303         -0.3094     0.4400    0.0813
## educ             10.3459       10.2354          0.0550     0.4959    0.0347
## raceblack         0.8432        0.2028          1.7615          .    0.6404
## racehispan        0.0595        0.1422         -0.3498          .    0.0827
## racewhite         0.0973        0.6550         -1.8819          .    0.5577
## married           0.1892        0.5128         -0.8263          .    0.3236
## nodegree          0.7081        0.5967          0.2450          .    0.1114
## re74           2095.5737     5619.2365         -0.7211     0.5181    0.2248
## re75           1532.0553     2466.4844         -0.2903     0.9563    0.1342
##            eCDF Max
## distance     0.6444
## age          0.1577
## educ         0.1114
## raceblack    0.6404
## racehispan   0.0827
## racewhite    0.5577
## married      0.3236
## nodegree     0.1114
## re74         0.4470
## re75         0.2876
## 
## 
## Sample Sizes:
##           Control Treated
## All           429     185
## Matched       429     185
## Unmatched       0       0
## Discarded       0       0</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Matching</li>
</ol>
<div class="sourceCode" id="cb1079"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 1:1 NN PS matching w/o replacement</span>
<span class="va">m.out1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> 
                   <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,
                 method <span class="op">=</span> <span class="st">"nearest"</span>, distance <span class="op">=</span> <span class="st">"glm"</span><span class="op">)</span>
<span class="va">m.out1</span></code></pre></div>
<pre><code>## A matchit object
##  - method: Variable ratio 1:1 nearest neighbor matching without replacement
##  - distance: Propensity score
##              - estimated with logistic regression
##  - number of obs.: 614 (original), 370 (matched)
##  - target estimand: ATT
##  - covariates: age, educ, race, married, nodegree, re74, re75</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Check balance</li>
</ol>
<p>Sometimes you have to make trade-off between balance and sample size.</p>
<div class="sourceCode" id="cb1081"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Checking balance after NN matching</span>
<span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="va">m.out1</span>, un <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
## matchit(formula = treat ~ age + educ + race + married + nodegree + 
##     re74 + re75, data = lalonde, method = "nearest", distance = "glm")
## 
## Summary of Balance for Matched Data:
##            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
## distance          0.5774        0.3629          0.9739     0.7566    0.1321
## age              25.8162       25.3027          0.0718     0.4568    0.0847
## educ             10.3459       10.6054         -0.1290     0.5721    0.0239
## raceblack         0.8432        0.4703          1.0259          .    0.3730
## racehispan        0.0595        0.2162         -0.6629          .    0.1568
## racewhite         0.0973        0.3135         -0.7296          .    0.2162
## married           0.1892        0.2108         -0.0552          .    0.0216
## nodegree          0.7081        0.6378          0.1546          .    0.0703
## re74           2095.5737     2342.1076         -0.0505     1.3289    0.0469
## re75           1532.0553     1614.7451         -0.0257     1.4956    0.0452
##            eCDF Max Std. Pair Dist.
## distance     0.4216          0.9740
## age          0.2541          1.3938
## educ         0.0757          1.2474
## raceblack    0.3730          1.0259
## racehispan   0.1568          1.0743
## racewhite    0.2162          0.8390
## married      0.0216          0.8281
## nodegree     0.0703          1.0106
## re74         0.2757          0.7965
## re75         0.2054          0.7381
## 
## Sample Sizes:
##           Control Treated
## All           429     185
## Matched       185     185
## Unmatched     244       0
## Discarded       0       0</code></pre>
<div class="sourceCode" id="cb1083"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># examine visually </span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">m.out1</span>, type <span class="op">=</span> <span class="st">"jitter"</span>, interactive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-44-1.png" width="672"></div>
<div class="sourceCode" id="cb1084"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">m.out1</span>, type <span class="op">=</span> <span class="st">"qq"</span>, interactive <span class="op">=</span> <span class="cn">FALSE</span>,
     which.xs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"married"</span>, <span class="st">"re75"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-44-2.png" width="672"></div>
<p>Try Full Match (i.e., every treated matches with one control, and every control with one treated).</p>
<div class="sourceCode" id="cb1085"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Full matching on a probit PS</span>
<span class="va">m.out2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> 
                   <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,
                 method <span class="op">=</span> <span class="st">"full"</span>, distance <span class="op">=</span> <span class="st">"glm"</span>, link <span class="op">=</span> <span class="st">"probit"</span><span class="op">)</span>
<span class="va">m.out2</span></code></pre></div>
<pre><code>## A matchit object
##  - method: Optimal full matching
##  - distance: Propensity score
##              - estimated with probit regression
##  - number of obs.: 614 (original), 614 (matched)
##  - target estimand: ATT
##  - covariates: age, educ, race, married, nodegree, re74, re75</code></pre>
<p>Checking balance again</p>
<div class="sourceCode" id="cb1087"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Checking balance after full matching</span>
<span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="va">m.out2</span>, un <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
## matchit(formula = treat ~ age + educ + race + married + nodegree + 
##     re74 + re75, data = lalonde, method = "full", distance = "glm", 
##     link = "probit")
## 
## Summary of Balance for Matched Data:
##            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
## distance          0.5773        0.5765          0.0040     0.9943    0.0042
## age              25.8162       25.6722          0.0201     0.4614    0.0848
## educ             10.3459       10.3693         -0.0116     0.6173    0.0194
## raceblack         0.8432        0.8389          0.0119          .    0.0043
## racehispan        0.0595        0.0500          0.0402          .    0.0095
## racewhite         0.0973        0.1111         -0.0467          .    0.0138
## married           0.1892        0.1580          0.0797          .    0.0312
## nodegree          0.7081        0.6898          0.0404          .    0.0184
## re74           2095.5737     2103.5534         -0.0016     1.3513    0.0328
## re75           1532.0553     1552.4673         -0.0063     1.5678    0.0496
##            eCDF Max Std. Pair Dist.
## distance     0.0541          0.0198
## age          0.2846          1.2741
## educ         0.0597          1.2233
## raceblack    0.0043          0.0162
## racehispan   0.0095          0.4985
## racewhite    0.0138          0.3911
## married      0.0312          0.4866
## nodegree     0.0184          0.9593
## re74         0.2159          0.8533
## re75         0.2013          0.8279
## 
## Sample Sizes:
##               Control Treated
## All            429.       185
## Matched (ESS)   53.51     185
## Matched        429.       185
## Unmatched        0.         0
## Discarded        0.         0</code></pre>
<div class="sourceCode" id="cb1089"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="va">m.out2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-46-1.png" width="672"></div>
<p>Exact Matching</p>
<div class="sourceCode" id="cb1090"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Full matching on a probit PS</span>
<span class="va">m.out3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> 
                   <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,
                 method <span class="op">=</span> <span class="st">"exact"</span><span class="op">)</span>
<span class="va">m.out3</span></code></pre></div>
<pre><code>## A matchit object
##  - method: Exact matching
##  - number of obs.: 614 (original), 25 (matched)
##  - target estimand: ATT
##  - covariates: age, educ, race, married, nodegree, re74, re75</code></pre>
<p>Subclassfication</p>
<div class="sourceCode" id="cb1092"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m.out4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span>
                   <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,
                 method <span class="op">=</span> <span class="st">"subclass"</span><span class="op">)</span>
<span class="va">m.out4</span></code></pre></div>
<pre><code>## A matchit object
##  - method: Subclassification (6 subclasses)
##  - distance: Propensity score
##              - estimated with logistic regression
##  - number of obs.: 614 (original), 614 (matched)
##  - target estimand: ATT
##  - covariates: age, educ, race, married, nodegree, re74, re75</code></pre>
<div class="sourceCode" id="cb1094"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Or you can use in conjunction with "nearest"</span>
<span class="va">m.out4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> 
                   <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,
                 method <span class="op">=</span> <span class="st">"nearest"</span>, option <span class="op">=</span> <span class="st">"subclass"</span><span class="op">)</span>
<span class="va">m.out4</span></code></pre></div>
<pre><code>## A matchit object
##  - method: Variable ratio 1:1 nearest neighbor matching without replacement
##  - distance: Propensity score
##              - estimated with logistic regression
##  - number of obs.: 614 (original), 370 (matched)
##  - target estimand: ATT
##  - covariates: age, educ, race, married, nodegree, re74, re75</code></pre>
<p>Optimal Matching</p>
<div class="sourceCode" id="cb1096"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m.out5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> 
                   <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,
                 method <span class="op">=</span> <span class="st">"optimal"</span>,ratio <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">m.out5</span></code></pre></div>
<pre><code>## A matchit object
##  - method: Variable ratio 2:1 optimal pair matching
##  - distance: Propensity score
##              - estimated with logistic regression
##  - number of obs.: 614 (original), 555 (matched)
##  - target estimand: ATT
##  - covariates: age, educ, race, married, nodegree, re74, re75</code></pre>
<p>Genetic Matching</p>
<div class="sourceCode" id="cb1098"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m.out6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> 
                   <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">lalonde</span>,
                 method <span class="op">=</span> <span class="st">"genetic"</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: (from Matching) The key tuning parameters for optimization were are
## all left at their default values. The 'pop.size' option in particular should
## probably be increased for optimal results. For details please see the help page
## and http://sekhon.berkeley.edu/papers/MatchingJSS.pdf</code></pre>
<div class="sourceCode" id="cb1100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m.out6</span></code></pre></div>
<pre><code>## A matchit object
##  - method: 1:1 genetic matching without replacement
##  - distance: Propensity score
##              - estimated with logistic regression
##  - number of obs.: 614 (original), 370 (matched)
##  - target estimand: ATT
##  - covariates: age, educ, race, married, nodegree, re74, re75</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Estimating the Treatment Effect</li>
</ol>
<div class="sourceCode" id="cb1102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># get matched data</span>
<span class="va">m.data1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">m.out1</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">m.data1</span><span class="op">)</span></code></pre></div>
<pre><code>##      treat age educ   race married nodegree re74 re75       re78  distance
## NSW1     1  37   11  black       1        1    0    0  9930.0460 0.6387699
## NSW2     1  22    9 hispan       0        1    0    0  3595.8940 0.2246342
## NSW3     1  30   12  black       0        0    0    0 24909.4500 0.6782439
## NSW4     1  27   11  black       0        1    0    0  7506.1460 0.7763241
## NSW5     1  33    8  black       0        1    0    0   289.7899 0.7016387
## NSW6     1  22    9  black       0        1    0    0  4056.4940 0.6990699
##      weights subclass
## NSW1       1        1
## NSW2       1       98
## NSW3       1      109
## NSW4       1      120
## NSW5       1      131
## NSW6       1      142</code></pre>
<div class="sourceCode" id="cb1104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"lmtest"</span><span class="op">)</span> <span class="co">#coeftest</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://sandwich.R-Forge.R-project.org/">"sandwich"</a></span><span class="op">)</span> <span class="co">#vcovCL</span>

<span class="co"># imbalance matched dataset</span>
<span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">re78</span> <span class="op">~</span> <span class="va">treat</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span> 
             <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">m.data1</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest</a></span><span class="op">(</span><span class="va">fit1</span>, vcov. <span class="op">=</span> <span class="va">vcovCL</span>, cluster <span class="op">=</span> <span class="op">~</span><span class="va">subclass</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## t test of coefficients:
## 
##                Estimate  Std. Error t value Pr(&gt;|t|)   
## (Intercept) -2.5816e+03  3.3209e+03 -0.7774 0.437439   
## treat        1.3449e+03  7.3084e+02  1.8403 0.066552 . 
## age          7.8035e+00  4.4148e+01  0.1768 0.859797   
## educ         6.0220e+02  2.1007e+02  2.8667 0.004391 **
## racehispan   1.5335e+03  1.0248e+03  1.4964 0.135417   
## racewhite    4.6943e+02  8.9854e+02  0.5224 0.601687   
## married     -1.5825e+02  9.3354e+02 -0.1695 0.865482   
## nodegree     9.2328e+02  1.1496e+03  0.8032 0.422412   
## re74         2.6362e-02  1.6646e-01  0.1584 0.874257   
## re75         2.2068e-01  1.6771e-01  1.3158 0.189069   
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
<p><code>treat</code> coefficient = estimated ATT</p>
<div class="sourceCode" id="cb1106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># balance matched dataset </span>
<span class="va">m.data2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">m.out2</span><span class="op">)</span>

<span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">re78</span> <span class="op">~</span> <span class="va">treat</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span> 
             <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>, data <span class="op">=</span> <span class="va">m.data2</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest</a></span><span class="op">(</span><span class="va">fit2</span>, vcov. <span class="op">=</span> <span class="va">vcovCL</span>, cluster <span class="op">=</span> <span class="op">~</span><span class="va">subclass</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## t test of coefficients:
## 
##                Estimate  Std. Error t value  Pr(&gt;|t|)    
## (Intercept)  2.8493e+03  3.1547e+03  0.9032 0.3667819    
## treat        1.9797e+03  7.5611e+02  2.6183 0.0090589 ** 
## age         -4.5799e+01  3.7917e+01 -1.2079 0.2275592    
## educ         2.3234e+02  2.0245e+02  1.1477 0.2515594    
## racehispan   9.6380e+02  1.4435e+03  0.6677 0.5045794    
## racewhite    1.7067e+03  8.2231e+02  2.0755 0.0383636 *  
## married      9.0378e+02  1.1858e+03  0.7622 0.4462384    
## nodegree    -1.2712e+03  1.2691e+03 -1.0017 0.3169017    
## re74        -1.1459e-02  1.4547e-01 -0.0788 0.9372369    
## re75         5.4080e-01  1.4212e-01  3.8053 0.0001561 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
<p>When reporting, remember to mention</p>
<ol style="list-style-type: decimal">
<li>the matching specification (method, and additional options)</li>
<li>the distance measure (e.g., propensity score)</li>
<li>other methods, and rationale for the final chosen method.</li>
<li>balance statistics of the matched dataset.</li>
<li>number of matched, unmatched, discarded</li>
<li>estimation method for treatment effect.</li>
</ol>
</div>
<div id="matchingfrontier" class="section level3" number="20.5.2">
<h3>
<span class="header-section-number">20.5.2</span> MatchingFrontier<a class="anchor" aria-label="anchor" href="#matchingfrontier"><i class="fas fa-link"></i></a>
</h3>
<p>As mentioned in <code>MatchIt</code>, you have to make trade-off (also known as bias-variance trade-off) between balance and sample size. An automated procedure to optimize this trade-off is implemented in <code>MatchingFrontier</code> <span class="citation">(<a href="references.html#ref-King_2016" role="doc-biblioref">G. King, Lucas, and Nielsen 2016</a>)</span>, which solves this joint optimization problem.</p>
<p>I follow <code>MatchingFrontier</code> <a href="https://projects.iq.harvard.edu/files/frontier/files/using_matchingfrontier.pdf">guide</a></p>
<div class="sourceCode" id="cb1108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># library(devtools)</span>
<span class="co"># install_github('ChristopherLucas/MatchingFrontier')</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://projects.iq.harvard.edu/frontier">MatchingFrontier</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"lalonde"</span><span class="op">)</span>
<span class="co"># choose var to match on</span>
<span class="va">match.on</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'re78'</span>, <span class="st">'treat'</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">match.on</span></code></pre></div>
<pre><code>## [1] "age"       "education" "black"     "hispanic"  "married"   "nodegree" 
## [7] "re74"      "re75"</code></pre>
<div class="sourceCode" id="cb1110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Mahanlanobis frontier (default)</span>
<span class="va">mahal.frontier</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/pkg/MatchingFrontier/man/makeFrontier.html">makeFrontier</a></span><span class="op">(</span>
        dataset <span class="op">=</span> <span class="va">lalonde</span>,
        treatment <span class="op">=</span> <span class="st">"treat"</span>,
        match.on <span class="op">=</span> <span class="va">match.on</span>
    <span class="op">)</span></code></pre></div>
<pre><code>## Calculating Mahalanobis distances...
## Calculating theoretical frontier...
## Calculating information for plotting the frontier...</code></pre>
<div class="sourceCode" id="cb1112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mahal.frontier</span></code></pre></div>
<pre><code>## An imbalance frontier with 997 points.</code></pre>
<div class="sourceCode" id="cb1114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># L1 frontier</span>
<span class="va">L1.frontier</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/pkg/MatchingFrontier/man/makeFrontier.html">makeFrontier</a></span><span class="op">(</span>
        dataset <span class="op">=</span> <span class="va">lalonde</span>,
        treatment <span class="op">=</span> <span class="st">'treat'</span>,
        match.on <span class="op">=</span> <span class="va">match.on</span>,
        QOI <span class="op">=</span> <span class="st">'SATT'</span>,
        metric <span class="op">=</span> <span class="st">'L1'</span>,
        ratio <span class="op">=</span> <span class="st">'fixed'</span>
    <span class="op">)</span></code></pre></div>
<pre><code>## Calculating L1 binnings...
## Calculating L1 frontier... This may take a few minutes...</code></pre>
<div class="sourceCode" id="cb1116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">L1.frontier</span></code></pre></div>
<pre><code>## An imbalance frontier with 976 points.</code></pre>
<div class="sourceCode" id="cb1118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># estimate effects along the frontier</span>

<span class="co"># Set base form</span>
<span class="va">my.form</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="va">re78</span> <span class="op">~</span> <span class="va">treat</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">black</span> <span class="op">+</span> <span class="va">education</span> <span class="op">+</span> <span class="va">hispanic</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span><span class="op">)</span>

<span class="co"># Estimate effects for the mahalanobis frontier</span>
<span class="va">mahal.estimates</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/pkg/MatchingFrontier/man/estimateEffects.html">estimateEffects</a></span><span class="op">(</span>
        <span class="va">mahal.frontier</span>,
        <span class="st">'re78 ~ treat'</span>,
        mod.dependence.formula <span class="op">=</span> <span class="va">my.form</span>,
        continuous.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'age'</span>, <span class="st">'education'</span>, <span class="st">'re74'</span>, <span class="st">'re75'</span><span class="op">)</span>,
        prop.estimated <span class="op">=</span> <span class="fl">.1</span>,
        means.as.cutpoints <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span></code></pre></div>
<pre><code>## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   1%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |==                                                                    |   3%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |====                                                                  |   5%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |======                                                                |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |========                                                              |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |==========                                                            |  14%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |================                                                      |  22%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |==================                                                    |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |====================                                                  |  28%
  |                                                                            
  |=====================                                                 |  29%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  31%
  |                                                                            
  |=======================                                               |  32%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |=========================                                             |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |===========================                                           |  38%
  |                                                                            
  |============================                                          |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |==============================                                        |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |================================                                      |  45%
  |                                                                            
  |=================================                                     |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |==================================                                    |  48%
  |                                                                            
  |===================================                                   |  49%
  |                                                                            
  |===================================                                   |  51%
  |                                                                            
  |====================================                                  |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |=====================================                                 |  54%
  |                                                                            
  |======================================                                |  55%
  |                                                                            
  |=======================================                               |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |========================================                              |  58%
  |                                                                            
  |=========================================                             |  59%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |==========================================                            |  61%
  |                                                                            
  |===========================================                           |  62%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |=============================================                         |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |===============================================                       |  68%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |=================================================                     |  71%
  |                                                                            
  |==================================================                    |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |====================================================                  |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |======================================================                |  78%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  84%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |==============================================================        |  88%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |================================================================      |  91%
  |                                                                            
  |================================================================      |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |==================================================================    |  95%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |===================================================================== |  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
<div class="sourceCode" id="cb1120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Estimate effects for the L1 frontier</span>
<span class="va">L1.estimates</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/pkg/MatchingFrontier/man/estimateEffects.html">estimateEffects</a></span><span class="op">(</span>
        <span class="va">L1.frontier</span>,
        <span class="st">'re78 ~ treat'</span>,
        mod.dependence.formula <span class="op">=</span> <span class="va">my.form</span>,
        continuous.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'age'</span>, <span class="st">'education'</span>, <span class="st">'re74'</span>, <span class="st">'re75'</span><span class="op">)</span>,
        prop.estimated <span class="op">=</span> <span class="fl">.1</span>,
        means.as.cutpoints <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span></code></pre></div>
<pre><code>## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   1%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |==                                                                    |   3%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |====                                                                  |   5%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |======                                                                |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |=========                                                             |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |==========                                                            |  14%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |============                                                          |  16%
  |                                                                            
  |============                                                          |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |==============                                                        |  21%
  |                                                                            
  |===============                                                       |  22%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |=================                                                     |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |===================                                                   |  28%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  31%
  |                                                                            
  |======================                                                |  32%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |=========================                                             |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |===========================                                           |  38%
  |                                                                            
  |===========================                                           |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |==============================                                        |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |================================                                      |  45%
  |                                                                            
  |================================                                      |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |==================================                                    |  48%
  |                                                                            
  |===================================                                   |  49%
  |                                                                            
  |===================================                                   |  51%
  |                                                                            
  |====================================                                  |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |======================================                                |  54%
  |                                                                            
  |======================================                                |  55%
  |                                                                            
  |=======================================                               |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |========================================                              |  58%
  |                                                                            
  |=========================================                             |  59%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |===========================================                           |  61%
  |                                                                            
  |===========================================                           |  62%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |=============================================                         |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |================================================                      |  68%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |===================================================                   |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |=======================================================               |  78%
  |                                                                            
  |========================================================              |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |==========================================================            |  82%
  |                                                                            
  |==========================================================            |  84%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |================================================================      |  91%
  |                                                                            
  |================================================================      |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |==================================================================    |  95%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |===================================================================== |  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
<div class="sourceCode" id="cb1122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Plot covariates means </span>
<span class="co"># plotPrunedMeans()</span>


<span class="co"># Plot estimates (deprecated)</span>
<span class="co"># plotEstimates(</span>
<span class="co">#     L1.estimates,</span>
<span class="co">#     ylim = c(-10000, 3000),</span>
<span class="co">#     cex.lab = 1.4,</span>
<span class="co">#     cex.axis = 1.4,</span>
<span class="co">#     panel.first = grid(NULL, NULL, lwd = 2,)</span>
<span class="co"># )</span>

<span class="co"># Plot estimates</span>
<span class="fu"><a href="https://rdrr.io/pkg/MatchingFrontier/man/plotMeans.html">plotMeans</a></span><span class="op">(</span><span class="va">L1.frontier</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-55-1.png" width="672"></div>
<div class="sourceCode" id="cb1123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># parallel plot</span>
<span class="fu"><a href="https://rdrr.io/pkg/MatchingFrontier/man/parallelPlot.html">parallelPlot</a></span><span class="op">(</span>
    <span class="va">L1.frontier</span>,
    N <span class="op">=</span> <span class="fl">400</span>,
    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'age'</span>, <span class="st">'re74'</span>, <span class="st">'re75'</span>, <span class="st">'black'</span><span class="op">)</span>,
    treated.col <span class="op">=</span> <span class="st">'blue'</span>,
    control.col <span class="op">=</span> <span class="st">'gray'</span>
<span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="20-quasi-experimental_files/figure-html/unnamed-chunk-55-2.png" width="672"></div>
<div class="sourceCode" id="cb1124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># export matched dataset</span>
<span class="va">matched.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MatchingFrontier/man/generateDataset.html">generateDataset</a></span><span class="op">(</span><span class="va">L1.frontier</span>, N <span class="op">=</span> <span class="fl">400</span><span class="op">)</span> <span class="co"># take 400 units</span></code></pre></div>
</div>
<div id="propensity-scores" class="section level3" number="20.5.3">
<h3>
<span class="header-section-number">20.5.3</span> Propensity Scores<a class="anchor" aria-label="anchor" href="#propensity-scores"><i class="fas fa-link"></i></a>
</h3>
<p>Even though I mention the propensity scores matching method here, it is no longer recommended to use such method in research and publication <span class="citation">(<a href="references.html#ref-King_2019" role="doc-biblioref">G. King and Nielsen 2019</a>)</span> because it increases</p>
<ul>
<li><p>imbalance</p></li>
<li><p>inefficiency</p></li>
<li><p>model dependence: small changes in the model specification lead to big changes in model results</p></li>
<li><p>bias</p></li>
</ul>
<p>PSM tries to accomplish complete randomization while other methods try to achieve fully blocked. Hence, you probably better off use any other methods.</p>
<p>Propensity is “the probability of receiving the treatment given the observed covariates.” <span class="citation">(<a href="references.html#ref-Rosenbaum_1985" role="doc-biblioref">Rosenbaum and Rubin 1985</a>)</span></p>
<p>Equivalently, it can to understood as the probability of being treated.</p>
<p><span class="math display">\[
e_i (X_i) = P(T_i = 1 | X_i)
\]</span></p>
<p>Estimation using</p>
<ul>
<li><p>logistic regression</p></li>
<li>
<p>Non parametric methods:</p>
<ul>
<li><p>boosted CART</p></li>
<li><p>generalized boosted models (gbm)</p></li>
</ul>
</li>
</ul>
<p>Steps by Gary King’s <a href="https://www.youtube.com/watch?v=rBv39pK1iEs&amp;ab_channel=MethodsColloquium">slides</a></p>
<ul>
<li><p>reduce k elements of X to scalar</p></li>
<li><p><span class="math inline">\(\pi_i \equiv P(T_i = 1|X) = \frac{1}{1+e^{X_i \beta}}\)</span></p></li>
<li><p>Distance (<span class="math inline">\(X_c, X_t\)</span>) = <span class="math inline">\(|\pi_c - \pi_t|\)</span></p></li>
<li><p>match each treated unit to the nearest control unit</p></li>
<li><p>control units: not reused; pruned if unused</p></li>
<li><p>prune matches if distances &gt; caliper</p></li>
</ul>
<p>In the best case scenario, you randomly prune, which increases imbalance</p>
<p>Other methods dominate because they try to match exactly hence</p>
<ul>
<li><p><span class="math inline">\(X_c = X_t \to \pi_c = \pi_t\)</span> (exact match leads to equal propensity scores) but</p></li>
<li><p><span class="math inline">\(\pi_c = \pi_t \nrightarrow X_c = X_t\)</span> (equal propensity scores do not necessarily lead to exact match)</p></li>
</ul>
<p>Do not include/control for irrelevant covariates because it leads your PSM to be more random, hence more imbalance</p>
<p>What you left with after pruning is more important than what you start with then throw out.</p>
<p>Diagnostics:</p>
<ul>
<li><p>balance of the covariates</p></li>
<li><p>no need to concern about collinearity</p></li>
<li><p>can’t use c-stat or stepwise because those model fit stat do not apply</p></li>
</ul>
<p><br></p>
</div>
<div id="mahalanobis-distance" class="section level3" number="20.5.4">
<h3>
<span class="header-section-number">20.5.4</span> Mahalanobis Distance<a class="anchor" aria-label="anchor" href="#mahalanobis-distance"><i class="fas fa-link"></i></a>
</h3>
<p>Approximates fully blocked experiment</p>
<p>Distance <span class="math inline">\((X_c,X_t)\)</span> = <span class="math inline">\(\sqrt{(X_c - X_t)'S^{-1}(X_c - X_t)}\)</span></p>
<p>where <span class="math inline">\(S^{-1}\)</span> standardize the distance</p>
<p>In application we use Euclidean distance.</p>
<p>Prune unused control units, and prune matches if distance &gt; caliper</p>
</div>
<div id="coarsened-exact-matching" class="section level3" number="20.5.5">
<h3>
<span class="header-section-number">20.5.5</span> Coarsened Exact Matching<a class="anchor" aria-label="anchor" href="#coarsened-exact-matching"><i class="fas fa-link"></i></a>
</h3>
<p>Steps from Gray King’s <a href="https://www.youtube.com/watch?v=rBv39pK1iEs&amp;ab_channel=MethodsColloquium">slides</a> International Methods Colloquium talk 2015</p>
<ul>
<li><p>Temporarily coarsen X</p></li>
<li>
<p>Apply exact matching to the coarsened X, C(X)</p>
<ul>
<li><p>sort observation into strata, each with unique values of C(X)</p></li>
<li><p>prune stratum with 0 treated or 0 control units</p></li>
</ul>
</li>
<li><p>Pass on original (uncoarsened) units except those pruned</p></li>
</ul>
<p><br></p>
<p>Properties:</p>
<ul>
<li>
<p>Monotonic imbalance bounding (MIB) matching method</p>
<ul>
<li>maximum imbalance between the treated and control chosen ex ante</li>
</ul>
</li>
<li><p>meets congruence principle</p></li>
<li><p>robust to measurement error</p></li>
<li><p>can be implemented with multiple imputation</p></li>
<li><p>works well for multi-category treatments</p></li>
</ul>
<p>Assumptions:</p>
<ul>
<li>Ignorability (i.e., no omitted variable bias)</li>
</ul>
<p>More detail in <span class="citation">(<a href="references.html#ref-Iacus_2012" role="doc-biblioref">Iacus, King, and Porro 2012</a>)</span></p>
<p>Example by <a href="https://cran.r-project.org/web/packages/cem/vignettes/cem.pdf">package’s authors</a></p>
<div class="sourceCode" id="cb1125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gking.harvard.edu/cem">cem</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: package 'cem' was built under R version 4.0.5</code></pre>
<pre><code>## Warning: package 'lattice' was built under R version 4.0.5</code></pre>
<div class="sourceCode" id="cb1128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">LeLonde</span><span class="op">)</span>

<span class="va">Le</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="va">LeLonde</span><span class="op">)</span><span class="op">)</span> <span class="co"># remove missing data</span>
<span class="co"># treated and control groups</span>
<span class="va">tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">Le</span><span class="op">$</span><span class="va">treated</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span>
<span class="va">ct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">Le</span><span class="op">$</span><span class="va">treated</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>
<span class="va">ntr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">tr</span><span class="op">)</span>
<span class="va">nct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ct</span><span class="op">)</span>

<span class="co"># unadjusted, biased difference in means</span>
<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Le</span><span class="op">$</span><span class="va">re78</span><span class="op">[</span><span class="va">tr</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Le</span><span class="op">$</span><span class="va">re78</span><span class="op">[</span><span class="va">ct</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 759.0479</code></pre>
<div class="sourceCode" id="cb1130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># pre-treatment covariates</span>
<span class="va">vars</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
        <span class="st">"age"</span>,
        <span class="st">"education"</span>,
        <span class="st">"black"</span>,
        <span class="st">"married"</span>,
        <span class="st">"nodegree"</span>,
        <span class="st">"re74"</span>,
        <span class="st">"re75"</span>,
        <span class="st">"hispanic"</span>,
        <span class="st">"u74"</span>,
        <span class="st">"u75"</span>,
        <span class="st">"q1"</span>
    <span class="op">)</span>

<span class="co"># overall imbalance statistics</span>
<span class="fu"><a href="https://rdrr.io/pkg/cem/man/imbalance.html">imbalance</a></span><span class="op">(</span>group<span class="op">=</span><span class="va">Le</span><span class="op">$</span><span class="va">treated</span>, data<span class="op">=</span><span class="va">Le</span><span class="op">[</span><span class="va">vars</span><span class="op">]</span><span class="op">)</span> <span class="co"># L1 = 0.902</span></code></pre></div>
<pre><code>## 
## Multivariate Imbalance Measure: L1=0.902
## Percentage of local common support: LCS=5.8%
## 
## Univariate Imbalance Measures:
## 
##               statistic   type           L1 min 25%      50%       75%
## age        -0.252373042 (diff) 5.102041e-03   0   0   0.0000   -1.0000
## education   0.153634710 (diff) 8.463851e-02   1   0   1.0000    1.0000
## black      -0.010322734 (diff) 1.032273e-02   0   0   0.0000    0.0000
## married    -0.009551495 (diff) 9.551495e-03   0   0   0.0000    0.0000
## nodegree   -0.081217371 (diff) 8.121737e-02   0  -1   0.0000    0.0000
## re74      -18.160446880 (diff) 5.551115e-17   0   0 284.0715  806.3452
## re75      101.501761679 (diff) 5.551115e-17   0   0 485.6310 1238.4114
## hispanic   -0.010144756 (diff) 1.014476e-02   0   0   0.0000    0.0000
## u74        -0.045582186 (diff) 4.558219e-02   0   0   0.0000    0.0000
## u75        -0.065555292 (diff) 6.555529e-02   0   0   0.0000    0.0000
## q1          7.494021189 (Chi2) 1.067078e-01  NA  NA       NA        NA
##                  max
## age          -6.0000
## education     1.0000
## black         0.0000
## married       0.0000
## nodegree      0.0000
## re74      -2139.0195
## re75        490.3945
## hispanic      0.0000
## u74           0.0000
## u75           0.0000
## q1                NA</code></pre>
<div class="sourceCode" id="cb1132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># drop other variables that are not pre-treatmentt matching variables</span>
<span class="va">todrop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"treated"</span>, <span class="st">"re78"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/cem/man/imbalance.html">imbalance</a></span><span class="op">(</span>group<span class="op">=</span><span class="va">Le</span><span class="op">$</span><span class="va">treated</span>, data<span class="op">=</span><span class="va">Le</span>, drop<span class="op">=</span><span class="va">todrop</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Multivariate Imbalance Measure: L1=0.902
## Percentage of local common support: LCS=5.8%
## 
## Univariate Imbalance Measures:
## 
##               statistic   type           L1 min 25%      50%       75%
## age        -0.252373042 (diff) 5.102041e-03   0   0   0.0000   -1.0000
## education   0.153634710 (diff) 8.463851e-02   1   0   1.0000    1.0000
## black      -0.010322734 (diff) 1.032273e-02   0   0   0.0000    0.0000
## married    -0.009551495 (diff) 9.551495e-03   0   0   0.0000    0.0000
## nodegree   -0.081217371 (diff) 8.121737e-02   0  -1   0.0000    0.0000
## re74      -18.160446880 (diff) 5.551115e-17   0   0 284.0715  806.3452
## re75      101.501761679 (diff) 5.551115e-17   0   0 485.6310 1238.4114
## hispanic   -0.010144756 (diff) 1.014476e-02   0   0   0.0000    0.0000
## u74        -0.045582186 (diff) 4.558219e-02   0   0   0.0000    0.0000
## u75        -0.065555292 (diff) 6.555529e-02   0   0   0.0000    0.0000
## q1          7.494021189 (Chi2) 1.067078e-01  NA  NA       NA        NA
##                  max
## age          -6.0000
## education     1.0000
## black         0.0000
## married       0.0000
## nodegree      0.0000
## re74      -2139.0195
## re75        490.3945
## hispanic      0.0000
## u74           0.0000
## u75           0.0000
## q1                NA</code></pre>
<p>automated coarsening</p>
<div class="sourceCode" id="cb1134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/cem/man/cem.html">cem</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="st">"treated"</span>, data <span class="op">=</span> <span class="va">Le</span>, drop <span class="op">=</span> <span class="st">"re78"</span>,keep.all<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Using 'treated'='1' as baseline group</code></pre>
<div class="sourceCode" id="cb1136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat</span></code></pre></div>
<pre><code>##            G0  G1
## All       392 258
## Matched    95  84
## Unmatched 297 174</code></pre>
<div class="sourceCode" id="cb1138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># mat$w</span></code></pre></div>
<p>coarsening by explicit user choice</p>
<div class="sourceCode" id="cb1139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># categorial variables</span>
<span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">Le</span><span class="op">$</span><span class="va">q1</span><span class="op">)</span> <span class="co"># grouping option</span></code></pre></div>
<pre><code>## [1] "agree"             "disagree"          "neutral"          
## [4] "no opinion"        "strongly agree"    "strongly disagree"</code></pre>
<div class="sourceCode" id="cb1141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q1.grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"strongly agree"</span>, <span class="st">"agree"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"neutral"</span>, <span class="st">"no opinion"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"strongly disagree"</span>,<span class="st">"disagree"</span><span class="op">)</span><span class="op">)</span> <span class="co"># if you want ordered categories</span>

<span class="co"># continuous variables </span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">Le</span><span class="op">$</span><span class="va">education</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##   3   4   5   6   7   8   9  10  11  12  13  14  15 
##   1   5   4   6  12  55 106 146 173 113  19   9   1</code></pre>
<div class="sourceCode" id="cb1143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">educut</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6.5</span>, <span class="fl">8.5</span>, <span class="fl">12.5</span>, <span class="fl">17</span><span class="op">)</span>  <span class="co"># use cutpoints</span>

<span class="va">mat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/cem/man/cem.html">cem</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="st">"treated"</span>, data <span class="op">=</span> <span class="va">Le</span>, drop <span class="op">=</span> <span class="st">"re78"</span>, cutpoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>education<span class="op">=</span><span class="va">educut</span><span class="op">)</span>, grouping<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/gsubfn/man/list.html">list</a></span><span class="op">(</span>q1<span class="op">=</span><span class="va">q1.grp</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Using 'treated'='1' as baseline group</code></pre>
<div class="sourceCode" id="cb1145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat1</span></code></pre></div>
<pre><code>##            G0  G1
## All       392 258
## Matched   158 115
## Unmatched 234 143</code></pre>
<ul>
<li><p>Can also use progressive coarsening method to control the number of matches.</p></li>
<li><p><code>cem</code> can also handle some missingness.</p></li>
</ul>
</div>
<div id="genetic-matching" class="section level3" number="20.5.6">
<h3>
<span class="header-section-number">20.5.6</span> Genetic Matching<a class="anchor" aria-label="anchor" href="#genetic-matching"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>GM uses iterative checking process of propensity scores, which combines propensity scores and Mahalanobis distance.</li>
</ul>
<!-- --><ul>
<li>GM is arguably “superior” method than nearest neighbor or full matching in imbalanced data</li>
</ul>
<!-- --><ul>
<li><p>Use a genetic search algorithm to find weights for each covariate such that we have optimal balance.</p></li>
<li>
<p>Implementation</p>
<ul>
<li><p>could use <em>with replacement</em></p></li>
<li>
<p>balance can be based on</p>
<ul>
<li><p>paired t-tests (dichotomous variables)</p></li>
<li><p>Kolmogorov-Smirnov (multinomial and continuous)</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Packages</p>
<p><code>Matching</code></p>
<div class="sourceCode" id="cb1147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://sekhon.berkeley.edu/matching/">Matching</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: package 'Matching' was built under R version 4.0.5</code></pre>
<pre><code>## Loading required package: MASS</code></pre>
<pre><code>## Warning: package 'MASS' was built under R version 4.0.5</code></pre>
<pre><code>## ## 
## ##  Matching (Version 4.9-9, Build Date: 2021-03-15)
## ##  See http://sekhon.berkeley.edu/matching for additional documentation.
## ##  Please cite software as:
## ##   Jasjeet S. Sekhon. 2011. ``Multivariate and Propensity Score Matching
## ##   Software with Automated Balance Optimization: The Matching package for R.''
## ##   Journal of Statistical Software, 42(7): 1-52. 
## ##</code></pre>
<div class="sourceCode" id="cb1152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/attach.html">attach</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">)</span>

<span class="co">#The covariates we want to match on</span>
<span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="https://amices.org/mice/reference/cbind.html">cbind</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">educ</span>, <span class="va">black</span>, <span class="va">hisp</span>, <span class="va">married</span>, <span class="va">nodegr</span>, <span class="va">u74</span>, <span class="va">u75</span>, <span class="va">re75</span>, <span class="va">re74</span><span class="op">)</span>

<span class="co">#The covariates we want to obtain balance on</span>
<span class="va">BalanceMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://amices.org/mice/reference/cbind.html">cbind</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">educ</span>, <span class="va">black</span>, <span class="va">hisp</span>, <span class="va">married</span>, <span class="va">nodegr</span>, <span class="va">u74</span>, <span class="va">u75</span>, <span class="va">re75</span>, <span class="va">re74</span>,
                    <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">re74</span><span class="op">*</span><span class="va">re75</span><span class="op">)</span><span class="op">)</span>

<span class="co">#</span>
<span class="co">#Let's call GenMatch() to find the optimal weight to give each</span>
<span class="co">#covariate in 'X' so as we have achieved balance on the covariates in</span>
<span class="co">#'BalanceMat'. This is only an example so we want GenMatch to be quick</span>
<span class="co">#so the population size has been set to be only 16 via the 'pop.size'</span>
<span class="co">#option. This is *WAY* too small for actual problems.</span>
<span class="co">#For details see http://sekhon.berkeley.edu/papers/MatchingJSS.pdf.</span>
<span class="co">#</span>
<span class="va">genout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/GenMatch.html">GenMatch</a></span><span class="op">(</span>Tr<span class="op">=</span><span class="va">treat</span>, X<span class="op">=</span><span class="va">X</span>, BalanceMatrix<span class="op">=</span><span class="va">BalanceMat</span>, estimand<span class="op">=</span><span class="st">"ATE"</span>, M<span class="op">=</span><span class="fl">1</span>,
                   pop.size<span class="op">=</span><span class="fl">16</span>, max.generations<span class="op">=</span><span class="fl">10</span>, wait.generations<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## 
## Mon Nov 22 14:39:20 2021
## Domains:
##  0.000000e+00   &lt;=  X1   &lt;=    1.000000e+03 
##  0.000000e+00   &lt;=  X2   &lt;=    1.000000e+03 
##  0.000000e+00   &lt;=  X3   &lt;=    1.000000e+03 
##  0.000000e+00   &lt;=  X4   &lt;=    1.000000e+03 
##  0.000000e+00   &lt;=  X5   &lt;=    1.000000e+03 
##  0.000000e+00   &lt;=  X6   &lt;=    1.000000e+03 
##  0.000000e+00   &lt;=  X7   &lt;=    1.000000e+03 
##  0.000000e+00   &lt;=  X8   &lt;=    1.000000e+03 
##  0.000000e+00   &lt;=  X9   &lt;=    1.000000e+03 
##  0.000000e+00   &lt;=  X10  &lt;=    1.000000e+03 
## 
## Data Type: Floating Point
## Operators (code number, name, population) 
##  (1) Cloning...........................  1
##  (2) Uniform Mutation..................  2
##  (3) Boundary Mutation.................  2
##  (4) Non-Uniform Mutation..............  2
##  (5) Polytope Crossover................  2
##  (6) Simple Crossover..................  2
##  (7) Whole Non-Uniform Mutation........  2
##  (8) Heuristic Crossover...............  2
##  (9) Local-Minimum Crossover...........  0
## 
## SOFT Maximum Number of Generations: 10
## Maximum Nonchanging Generations: 1
## Population size       : 16
## Convergence Tolerance: 1.000000e-03
## 
## Not Using the BFGS Derivative Based Optimizer on the Best Individual Each Generation.
## Not Checking Gradients before Stopping.
## Using Out of Bounds Individuals.
## 
## Maximization Problem.
## GENERATION: 0 (initializing the population)
## Lexical Fit..... 1.747466e-01  1.795176e-01  1.795176e-01  2.755332e-01  3.173114e-01  3.173114e-01  3.857502e-01  3.937274e-01  7.390086e-01  7.390086e-01  8.024999e-01  8.910491e-01  9.688444e-01  9.917159e-01  9.989079e-01  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  
## #unique......... 16, #Total UniqueCount: 16
## var 1:
## best............ 3.758091e+02
## mean............ 4.897395e+02
## variance........ 9.320437e+04
## var 2:
## best............ 4.944768e+02
## mean............ 5.218593e+02
## variance........ 6.830606e+04
## var 3:
## best............ 1.880547e+02
## mean............ 4.838327e+02
## variance........ 1.030481e+05
## var 4:
## best............ 8.125678e+02
## mean............ 4.445995e+02
## variance........ 8.135038e+04
## var 5:
## best............ 9.058067e+02
## mean............ 4.753729e+02
## variance........ 1.184631e+05
## var 6:
## best............ 1.733063e+02
## mean............ 4.782400e+02
## variance........ 8.948808e+04
## var 7:
## best............ 5.766096e+02
## mean............ 4.722599e+02
## variance........ 7.199369e+04
## var 8:
## best............ 3.736603e+02
## mean............ 4.108310e+02
## variance........ 8.454007e+04
## var 9:
## best............ 5.987977e+02
## mean............ 3.762504e+02
## variance........ 7.462591e+04
## var 10:
## best............ 5.352480e+02
## mean............ 4.491692e+02
## variance........ 8.739694e+04
## 
## GENERATION: 1
## Lexical Fit..... 1.747466e-01  1.795176e-01  1.795176e-01  2.755332e-01  3.173114e-01  3.173114e-01  3.857502e-01  3.937274e-01  7.390086e-01  7.390086e-01  8.024999e-01  8.910491e-01  9.688444e-01  9.917159e-01  9.989079e-01  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  
## #unique......... 12, #Total UniqueCount: 28
## var 1:
## best............ 3.758091e+02
## mean............ 3.556052e+02
## variance........ 6.953381e+03
## var 2:
## best............ 4.944768e+02
## mean............ 5.087018e+02
## variance........ 3.156408e+03
## var 3:
## best............ 1.880547e+02
## mean............ 1.798786e+02
## variance........ 4.539894e+03
## var 4:
## best............ 8.125678e+02
## mean............ 6.669235e+02
## variance........ 5.540181e+04
## var 5:
## best............ 9.058067e+02
## mean............ 9.117080e+02
## variance........ 3.397508e+03
## var 6:
## best............ 1.733063e+02
## mean............ 2.041563e+02
## variance........ 3.552940e+04
## var 7:
## best............ 5.766096e+02
## mean............ 4.995566e+02
## variance........ 2.585541e+04
## var 8:
## best............ 3.736603e+02
## mean............ 5.068097e+02
## variance........ 4.273372e+04
## var 9:
## best............ 5.987977e+02
## mean............ 4.917595e+02
## variance........ 3.084008e+04
## var 10:
## best............ 5.352480e+02
## mean............ 5.445554e+02
## variance........ 8.587358e+03
## 
## GENERATION: 2
## Lexical Fit..... 1.747466e-01  1.795176e-01  1.795176e-01  2.755332e-01  3.173114e-01  3.173114e-01  3.857502e-01  3.937274e-01  7.390086e-01  7.390086e-01  8.024999e-01  8.910491e-01  9.688444e-01  9.917159e-01  9.989079e-01  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  
## #unique......... 8, #Total UniqueCount: 36
## var 1:
## best............ 3.758091e+02
## mean............ 3.562379e+02
## variance........ 2.385358e+03
## var 2:
## best............ 4.944768e+02
## mean............ 4.956205e+02
## variance........ 1.566415e+02
## var 3:
## best............ 1.880547e+02
## mean............ 2.166244e+02
## variance........ 6.801191e+03
## var 4:
## best............ 8.125678e+02
## mean............ 8.059555e+02
## variance........ 6.565662e+02
## var 5:
## best............ 9.058067e+02
## mean............ 8.852994e+02
## variance........ 3.056774e+03
## var 6:
## best............ 1.733063e+02
## mean............ 2.210856e+02
## variance........ 2.369334e+04
## var 7:
## best............ 5.766096e+02
## mean............ 5.482967e+02
## variance........ 4.613957e+03
## var 8:
## best............ 3.736603e+02
## mean............ 3.943396e+02
## variance........ 1.895797e+03
## var 9:
## best............ 5.987977e+02
## mean............ 6.005851e+02
## variance........ 3.308459e+02
## var 10:
## best............ 5.352480e+02
## mean............ 5.444285e+02
## variance........ 4.950778e+02
## 
## 'wait.generations' limit reached.
## No significant improvement in 1 generations.
## 
## Solution Lexical Fitness Value:
## 1.747466e-01  1.795176e-01  1.795176e-01  2.755332e-01  3.173114e-01  3.173114e-01  3.857502e-01  3.937274e-01  7.390086e-01  7.390086e-01  8.024999e-01  8.910491e-01  9.688444e-01  9.917159e-01  9.989079e-01  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  1.000000e+00  
## 
## Parameters at the Solution:
## 
##  X[ 1] : 3.758091e+02
##  X[ 2] : 4.944768e+02
##  X[ 3] : 1.880547e+02
##  X[ 4] : 8.125678e+02
##  X[ 5] : 9.058067e+02
##  X[ 6] : 1.733063e+02
##  X[ 7] : 5.766096e+02
##  X[ 8] : 3.736603e+02
##  X[ 9] : 5.987977e+02
##  X[10] : 5.352480e+02
## 
## Solution Found Generation 1
## Number of Generations Run 2
## 
## Mon Nov 22 14:39:21 2021
## Total run time : 0 hours 0 minutes and 1 seconds</code></pre>
<div class="sourceCode" id="cb1154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#The outcome variable</span>
<span class="va">Y</span><span class="op">=</span><span class="va">re78</span><span class="op">/</span><span class="fl">1000</span>

<span class="co">#</span>
<span class="co"># Now that GenMatch() has found the optimal weights, let's estimate</span>
<span class="co"># our causal effect of interest using those weights</span>
<span class="co">#</span>
<span class="va">mout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/Match.html">Match</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>, Tr<span class="op">=</span><span class="va">treat</span>, X<span class="op">=</span><span class="va">X</span>, estimand<span class="op">=</span><span class="st">"ATE"</span>, Weight.matrix<span class="op">=</span><span class="va">genout</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="va">mout</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Estimate...  1.9046 
## AI SE......  0.82198 
## T-stat.....  2.3171 
## p.val......  0.020498 
## 
## Original number of observations..............  445 
## Original number of treated obs...............  185 
## Matched number of observations...............  445 
## Matched number of observations  (unweighted).  597</code></pre>
<div class="sourceCode" id="cb1156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#                        </span>
<span class="co">#Let's determine if balance has actually been obtained on the variables of interest</span>
<span class="co">#                        </span>
<span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matching/man/MatchBalance.html">MatchBalance</a></span><span class="op">(</span><span class="va">treat</span><span class="op">~</span><span class="va">age</span> <span class="op">+</span><span class="va">educ</span><span class="op">+</span><span class="va">black</span><span class="op">+</span> <span class="va">hisp</span><span class="op">+</span> <span class="va">married</span><span class="op">+</span> <span class="va">nodegr</span><span class="op">+</span> <span class="va">u74</span><span class="op">+</span> <span class="va">u75</span><span class="op">+</span>
                   <span class="va">re75</span><span class="op">+</span> <span class="va">re74</span><span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">re74</span><span class="op">*</span><span class="va">re75</span><span class="op">)</span>,
                   match.out<span class="op">=</span><span class="va">mout</span>, nboots<span class="op">=</span><span class="fl">500</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## ***** (V1) age *****
##                        Before Matching        After Matching
## mean treatment........     25.816             25.112 
## mean control..........     25.054             24.902 
## std mean diff.........     10.655             3.1286 
## 
## mean raw eQQ diff.....    0.94054            0.36181 
## med  raw eQQ diff.....          1                  0 
## max  raw eQQ diff.....          7                  8 
## 
## mean eCDF diff........   0.025364          0.0099025 
## med  eCDF diff........   0.022193          0.0075377 
## max  eCDF diff........   0.065177           0.028476 
## 
## var ratio (Tr/Co).....     1.0278            0.98286 
## T-test p-value........    0.26594            0.27553 
## KS Bootstrap p-value..      0.504              0.842 
## KS Naive p-value......     0.7481            0.96884 
## KS Statistic..........   0.065177           0.028476 
## 
## 
## ***** (V2) educ *****
##                        Before Matching        After Matching
## mean treatment........     10.346             10.189 
## mean control..........     10.088             10.222 
## std mean diff.........     12.806            -1.9653 
## 
## mean raw eQQ diff.....    0.40541           0.098827 
## med  raw eQQ diff.....          0                  0 
## max  raw eQQ diff.....          2                  2 
## 
## mean eCDF diff........   0.028698          0.0070591 
## med  eCDF diff........   0.012682          0.0033501 
## max  eCDF diff........    0.12651           0.033501 
## 
## var ratio (Tr/Co).....     1.5513             1.0458 
## T-test p-value........    0.15017            0.38575 
## KS Bootstrap p-value..       0.02              0.454 
## KS Naive p-value......   0.062873            0.89105 
## KS Statistic..........    0.12651           0.033501 
## 
## 
## ***** (V3) black *****
##                        Before Matching        After Matching
## mean treatment........    0.84324             0.8382 
## mean control..........    0.82692             0.8382 
## std mean diff.........     4.4767                  0 
## 
## mean raw eQQ diff.....   0.016216                  0 
## med  raw eQQ diff.....          0                  0 
## max  raw eQQ diff.....          1                  0 
## 
## mean eCDF diff........  0.0081601                  0 
## med  eCDF diff........  0.0081601                  0 
## max  eCDF diff........    0.01632                  0 
## 
## var ratio (Tr/Co).....    0.92503                  1 
## T-test p-value........    0.64736                  1 
## 
## 
## ***** (V4) hisp *****
##                        Before Matching        After Matching
## mean treatment........   0.059459            0.08764 
## mean control..........    0.10769            0.08764 
## std mean diff.........    -20.341                  0 
## 
## mean raw eQQ diff.....   0.048649                  0 
## med  raw eQQ diff.....          0                  0 
## max  raw eQQ diff.....          1                  0 
## 
## mean eCDF diff........   0.024116                  0 
## med  eCDF diff........   0.024116                  0 
## max  eCDF diff........   0.048233                  0 
## 
## var ratio (Tr/Co).....    0.58288                  1 
## T-test p-value........   0.064043                  1 
## 
## 
## ***** (V5) married *****
##                        Before Matching        After Matching
## mean treatment........    0.18919            0.16854 
## mean control..........    0.15385            0.16854 
## std mean diff.........     8.9995                  0 
## 
## mean raw eQQ diff.....   0.037838                  0 
## med  raw eQQ diff.....          0                  0 
## max  raw eQQ diff.....          1                  0 
## 
## mean eCDF diff........   0.017672                  0 
## med  eCDF diff........   0.017672                  0 
## max  eCDF diff........   0.035343                  0 
## 
## var ratio (Tr/Co).....     1.1802                  1 
## T-test p-value........    0.33425                  1 
## 
## 
## ***** (V6) nodegr *****
##                        Before Matching        After Matching
## mean treatment........    0.70811            0.78876 
## mean control..........    0.83462            0.78652 
## std mean diff.........    -27.751            0.54991 
## 
## mean raw eQQ diff.....    0.12432           0.001675 
## med  raw eQQ diff.....          0                  0 
## max  raw eQQ diff.....          1                  1 
## 
## mean eCDF diff........   0.063254         0.00083752 
## med  eCDF diff........   0.063254         0.00083752 
## max  eCDF diff........    0.12651           0.001675 
## 
## var ratio (Tr/Co).....     1.4998             0.9923 
## T-test p-value........  0.0020368            0.73901 
## 
## 
## ***** (V7) u74 *****
##                        Before Matching        After Matching
## mean treatment........    0.70811            0.73258 
## mean control..........       0.75            0.73034 
## std mean diff.........    -9.1895            0.50714 
## 
## mean raw eQQ diff.....   0.037838           0.001675 
## med  raw eQQ diff.....          0                  0 
## max  raw eQQ diff.....          1                  1 
## 
## mean eCDF diff........   0.020946         0.00083752 
## med  eCDF diff........   0.020946         0.00083752 
## max  eCDF diff........   0.041892           0.001675 
## 
## var ratio (Tr/Co).....     1.1041            0.99472 
## T-test p-value........    0.33033            0.31731 
## 
## 
## ***** (V8) u75 *****
##                        Before Matching        After Matching
## mean treatment........        0.6            0.64494 
## mean control..........    0.68462            0.65169 
## std mean diff.........    -17.225            -1.4072 
## 
## mean raw eQQ diff.....   0.081081          0.0050251 
## med  raw eQQ diff.....          0                  0 
## max  raw eQQ diff.....          1                  1 
## 
## mean eCDF diff........   0.042308          0.0025126 
## med  eCDF diff........   0.042308          0.0025126 
## max  eCDF diff........   0.084615          0.0050251 
## 
## var ratio (Tr/Co).....     1.1133             1.0088 
## T-test p-value........   0.068031            0.17952 
## 
## 
## ***** (V9) re75 *****
##                        Before Matching        After Matching
## mean treatment........     1532.1             1300.3 
## mean control..........     1266.9             1317.3 
## std mean diff.........     8.2363            -0.5676 
## 
## mean raw eQQ diff.....     367.61             104.16 
## med  raw eQQ diff.....          0                  0 
## max  raw eQQ diff.....     2110.2             2510.6 
## 
## mean eCDF diff........   0.050834          0.0080924 
## med  eCDF diff........   0.061954          0.0067002 
## max  eCDF diff........    0.10748           0.021776 
## 
## var ratio (Tr/Co).....     1.0763            0.97978 
## T-test p-value........    0.38527             0.8025 
## KS Bootstrap p-value..      0.044              0.824 
## KS Naive p-value......    0.16449            0.99891 
## KS Statistic..........    0.10748           0.021776 
## 
## 
## ***** (V10) re74 *****
##                        Before Matching        After Matching
## mean treatment........     2095.6             2019.8 
## mean control..........       2107             2106.4 
## std mean diff.........   -0.23437             -1.768 
## 
## mean raw eQQ diff.....     487.98             243.25 
## med  raw eQQ diff.....          0                  0 
## max  raw eQQ diff.....       8413             7870.3 
## 
## mean eCDF diff........   0.019223          0.0083159 
## med  eCDF diff........     0.0158          0.0067002 
## max  eCDF diff........   0.047089           0.025126 
## 
## var ratio (Tr/Co).....     0.7381            0.85755 
## T-test p-value........    0.98186            0.39373 
## KS Bootstrap p-value..      0.556              0.596 
## KS Naive p-value......    0.97023            0.99172 
## KS Statistic..........   0.047089           0.025126 
## 
## 
## ***** (V11) I(re74 * re75) *****
##                        Before Matching        After Matching
## mean treatment........   13118591           12261673 
## mean control..........   14530303           14240665 
## std mean diff.........    -2.7799            -4.2761 
## 
## mean raw eQQ diff.....    3278733            2602379 
## med  raw eQQ diff.....          0                  0 
## max  raw eQQ diff.....  188160151          223801517 
## 
## mean eCDF diff........   0.022723          0.0043797 
## med  eCDF diff........   0.014449          0.0033501 
## max  eCDF diff........   0.061019           0.011725 
## 
## var ratio (Tr/Co).....    0.69439            0.58474 
## T-test p-value........    0.79058            0.17475 
## KS Bootstrap p-value..      0.266              0.994 
## KS Naive p-value......    0.81575                  1 
## KS Statistic..........   0.061019           0.011725 
## 
## 
## Before Matching Minimum p.value: 0.0020368 
## Variable Name(s): nodegr  Number(s): 6 
## 
## After Matching Minimum p.value: 0.17475 
## Variable Name(s): I(re74 * re75)  Number(s): 11</code></pre>
</div>
<div id="matching-for-time-series-cross-section-data" class="section level3" number="20.5.7">
<h3>
<span class="header-section-number">20.5.7</span> Matching for time series-cross-section data<a class="anchor" aria-label="anchor" href="#matching-for-time-series-cross-section-data"><i class="fas fa-link"></i></a>
</h3>
<p>Examples: <span class="citation">(<a href="references.html#ref-SCHEVE_2012" role="doc-biblioref">SCHEVE and STASAVAGE 2012</a>)</span> and <span class="citation">(<a href="references.html#ref-Acemoglu_2014" role="doc-biblioref">Acemoglu et al. 2014</a>)</span></p>
<p>Materials from Imai et al.’s <a href="https://imai.fas.harvard.edu/talk/files/polmeth18.pdf">slides</a></p>
<p>Identification strategy:</p>
<ul>
<li><p>Within-unit over-time variation</p></li>
<li><p>within-time across-units variation</p></li>
</ul>
</div>
</div>
<div id="interrupted-time-series" class="section level2" number="20.6">
<h2>
<span class="header-section-number">20.6</span> Interrupted Time Series<a class="anchor" aria-label="anchor" href="#interrupted-time-series"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>
<p>Control for</p>
<ul>
<li><p>Seasonable trends</p></li>
<li><p>Concurrent events</p></li>
</ul>
</li>
<li>
<p>Pros <span class="citation">(<a href="references.html#ref-Penfold_2013" role="doc-biblioref">Penfold and Zhang 2013</a>)</span></p>
<ul>
<li>control for long-term trends</li>
</ul>
</li>
<li>
<p>Cons</p>
<ul>
<li><p>Min of 8 data points before and 8 after an intervention</p></li>
<li><p>Multiple events hard to distinguish</p></li>
</ul>
</li>
</ul>
<p>Example by <a href="https://towardsdatascience.com/what-is-the-strongest-quasi-experimental-method-interrupted-time-series-period-f59fe5b00b31">Leihua Ye</a></p>
<div class="sourceCode" id="cb1158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data preparation</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">CaseID</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="fl">6</span><span class="op">)</span>

<span class="co"># intervention</span>
<span class="va">Intervention</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">300</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">300</span><span class="op">)</span><span class="op">)</span>
<span class="va">Outcome_Variable</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">300</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">300</span><span class="op">)</span> <span class="op">*</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>

<span class="va">mydata</span> <span class="op">=</span> <span class="fu"><a href="https://amices.org/mice/reference/cbind.html">cbind</a></span><span class="op">(</span><span class="va">CaseID</span>, <span class="va">Intervention</span>, <span class="va">Outcome_Variable</span><span class="op">)</span>

<span class="va">mydata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">mydata</span><span class="op">)</span>

<span class="co">#construct a simple OLS model</span>
<span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Outcome_Variable</span> <span class="op">~</span> <span class="va">Intervention</span>, data <span class="op">=</span> <span class="va">mydata</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/spaMM/man/summary.HL.html">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = Outcome_Variable ~ Intervention, data = mydata)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.3050 -1.2315 -0.1734  0.8691 11.9185 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   0.03358    0.11021   0.305    0.761    
## Intervention  3.28903    0.15586  21.103   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 1.909 on 598 degrees of freedom
## Multiple R-squared:  0.4268, Adjusted R-squared:  0.4259 
## F-statistic: 445.3 on 1 and 598 DF,  p-value: &lt; 2.2e-16</code></pre>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="experimental-design.html"><span class="header-section-number">19</span> Experimental Design</a></div>
<div class="next"><a href="endogeneity.html"><span class="header-section-number">21</span> Endogeneity</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#quasi-experimental"><span class="header-section-number">20</span> Quasi-experimental</a></li>
<li>
<a class="nav-link" href="#regression-discontinuity"><span class="header-section-number">20.1</span> Regression Discontinuity</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#bunching-test"><span class="header-section-number">20.1.1</span> Bunching Test</a></li>
<li><a class="nav-link" href="#placebo-test"><span class="header-section-number">20.1.2</span> Placebo Test</a></li>
<li><a class="nav-link" href="#examples"><span class="header-section-number">20.1.3</span> Examples</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#difference-in-differences"><span class="header-section-number">20.2</span> Difference-In-Differences</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#simple-dif-n-dif"><span class="header-section-number">20.2.1</span> Simple Dif-n-dif</a></li>
<li><a class="nav-link" href="#staggered-dif-n-dif"><span class="header-section-number">20.2.2</span> Staggered Dif-n-dif</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#synthetic-control"><span class="header-section-number">20.3</span> Synthetic Control</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#example-1-2"><span class="header-section-number">20.3.1</span> Example 1</a></li>
<li><a class="nav-link" href="#example-2-1"><span class="header-section-number">20.3.2</span> Example 2</a></li>
<li><a class="nav-link" href="#example-3"><span class="header-section-number">20.3.3</span> Example 3</a></li>
<li><a class="nav-link" href="#example-4"><span class="header-section-number">20.3.4</span> Example 4</a></li>
</ul>
</li>
<li><a class="nav-link" href="#selection-on-observables"><span class="header-section-number">20.4</span> Selection on observables</a></li>
<li>
<a class="nav-link" href="#matching-methods"><span class="header-section-number">20.5</span> Matching Methods</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#matchit"><span class="header-section-number">20.5.1</span> MatchIt</a></li>
<li><a class="nav-link" href="#matchingfrontier"><span class="header-section-number">20.5.2</span> MatchingFrontier</a></li>
<li><a class="nav-link" href="#propensity-scores"><span class="header-section-number">20.5.3</span> Propensity Scores</a></li>
<li><a class="nav-link" href="#mahalanobis-distance"><span class="header-section-number">20.5.4</span> Mahalanobis Distance</a></li>
<li><a class="nav-link" href="#coarsened-exact-matching"><span class="header-section-number">20.5.5</span> Coarsened Exact Matching</a></li>
<li><a class="nav-link" href="#genetic-matching"><span class="header-section-number">20.5.6</span> Genetic Matching</a></li>
<li><a class="nav-link" href="#matching-for-time-series-cross-section-data"><span class="header-section-number">20.5.7</span> Matching for time series-cross-section data</a></li>
</ul>
</li>
<li><a class="nav-link" href="#interrupted-time-series"><span class="header-section-number">20.6</span> Interrupted Time Series</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/mikenguyen13/data_analysis/blob/master/20-quasi-experimental.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/mikenguyen13/data_analysis/edit/master/20-quasi-experimental.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>A Guide on Data Analysis</strong>" was written by Mike Nguyen. It was last built on 2021-11-22.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
